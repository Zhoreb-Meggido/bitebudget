<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voedseljournaal App v3.4</title>
  <!-- Refactored: Structured with DatabaseService layer for better maintainability -->
  
  <!-- Dexie.js for IndexedDB -->
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.1/jspdf.plugin.autotable.min.js"></script>
  
  <!-- React & Babel voor Journaal -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Chart.js voor Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .app-section {
      display: none;
    }
    .app-section.active {
      display: block;
    }
    .stat-card {
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
  
.backup-reminder {
  animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
  from {
    transform: translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

</style>
</head>
<body class="bg-gray-50">
<!-- Backup Reminder Banner -->
<div id="backup-reminder" class="hidden backup-reminder bg-yellow-50 border-b-2 border-yellow-400 p-3">
  <div class="max-w-7xl mx-auto px-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <span class="text-2xl">‚ö†Ô∏è</span>
      <div>
        <p class="text-sm font-semibold text-yellow-800">Tijd voor een backup!</p>
        <p class="text-xs text-yellow-700" id="backup-reminder-text"></p>
      </div>
    </div>
    <div class="flex gap-2">
      <button onclick="goToDataTab()" class="px-3 py-1 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700 transition">
        üíæ Backup maken
      </button>
      <button onclick="dismissBackupReminder()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300 transition">
        ‚úï
      </button>
    </div>
  </div>
</div>


<!-- ============================================ -->
<!-- üóÑÔ∏è DATA ACCESS LAYER                        -->
<!-- ============================================ -->
<script>
  /**
   * DatabaseService - Single source of truth for all database operations
   */
  const DatabaseService = {
    db: null,
    MIGRATION_KEY: 'indexeddb_migrated_v2',
    
    async init() {
      this.db = new Dexie('VoedseljournaalDB');
      
      this.db.version(1).stores({
        entries: 'id, date, created_at, updated_at',
        products: 'id, name, created_at, updated_at'
      });
      
      this.db.version(2).stores({
        entries: 'id, date, created_at, updated_at',
        products: 'id, name, created_at, updated_at',
        weights: 'id, date, created_at'
      });
      
      this.db.version(3).stores({
        entries: 'id, date, created_at, updated_at',
        products: 'id, name, created_at, updated_at',
        weights: 'id, date, created_at',
        settings: 'key'
      });
      
      // Set global reference for compatibility
      window.db = this.db;
      
      console.log('‚úÖ Database initialized');
      await this.migrateFromLocalStorage();
    },
    
    async migrateFromLocalStorage() {
      if (localStorage.getItem(this.MIGRATION_KEY)) {
        console.log('üìä Migration already completed');
        return;
      }
      
      console.log('üîÑ Starting migration from localStorage...');
      
      try {
        const now = new Date().toISOString();
        
        const savedEntries = localStorage.getItem('foodJournalEntries');
        if (savedEntries) {
          const entries = JSON.parse(savedEntries);
          const migratedEntries = entries.map(entry => ({
            ...entry,
            created_at: entry.created_at || now,
            updated_at: entry.updated_at || now
          }));
          await this.db.entries.bulkPut(migratedEntries);
          console.log(`‚úÖ Migrated ${migratedEntries.length} entries`);
        }
        
        const savedProducts = localStorage.getItem('foodProductDatabase');
        if (savedProducts) {
          const products = JSON.parse(savedProducts);
          const migratedProducts = products.map(product => ({
            ...product,
            created_at: product.created_at || now,
            updated_at: product.updated_at || now
          }));
          await this.db.products.bulkPut(migratedProducts);
          console.log(`‚úÖ Migrated ${migratedProducts.length} products`);
        }
        
        localStorage.setItem(this.MIGRATION_KEY, 'true');
        console.log('‚úÖ Migration completed');
      } catch (error) {
        console.error('‚ùå Migration failed:', error);
      }
    }
  };
</script>

<!-- ============================================ -->
<!-- üöÄ INITIALIZATION                            -->
<!-- ============================================ -->
<script>
  window.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Starting Voedseljournaal App v3.4 (With Data Tab)');
    
    try {
      await DatabaseService.init();
      console.log('‚úÖ App initialized successfully');
    } catch (error) {
      console.error('‚ùå Initialization error:', error);
      alert('Er is een fout opgetreden bij het starten van de app. Ververs de pagina.');
    }
  });
</script>


  <!-- Tab Navigation -->
  <div class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-4 gap-3">
        <h1 class="text-2xl font-bold text-gray-800">ü•ó Voedseljournaal App <span class="text-sm text-green-600">v3.4</span></h1>
        <div class="flex gap-2">
          <button 
            onclick="switchTab('journal')" 
            id="tab-journal"
            class="px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-blue-600 text-white text-base sm:text-base"
          >
            üìù<span class="hidden sm:inline"> Journaal</span>
          </button>
          <button 
            onclick="switchTab('tracking')" 
            id="tab-tracking"
            class="px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300 text-base sm:text-base"
          >
            ‚öñÔ∏è<span class="hidden sm:inline"> Tracking</span>
          </button>
          <button 
            onclick="switchTab('dashboard')" 
            id="tab-dashboard"
            class="px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300 text-base sm:text-base"
          >
            üìä<span class="hidden sm:inline"> Dashboard</span>
          </button>
          <button 
            onclick="switchTab('analysis')" 
            id="tab-analysis"
            class="px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300 text-base sm:text-base"
          >
            üìà<span class="hidden sm:inline"> Analyse</span>
          </button>
    <button 
  onclick="switchTab('data')" 
  id="tab-data"
  class="px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300 text-base sm:text-base"
>
  üíæ<span class="hidden sm:inline"> Data</span>
</button>

          <button 
            onclick="switchTab('settings')" 
            id="tab-settings"
            class="px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300 text-base sm:text-base"
          >
            ‚öôÔ∏è<span class="hidden sm:inline"> Settings</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Journal Section (React) -->
  <div id="journal-section" class="app-section active">
    <div id="root"></div>
  </div>

  <!-- Tracking Section -->
  <div id="tracking-section" class="app-section">
    <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 p-4 md:p-8">
      <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">‚öñÔ∏è Gewicht Tracking</h2>
          <p class="text-gray-600">Huidige: <span class="font-semibold" id="current-weight">--</span> kg ‚Ä¢ Doel: <span class="font-semibold text-green-600" id="target-weight">78</span> kg ‚Ä¢ Te gaan: <span class="font-semibold text-blue-600" id="weight-to-go">--</span> kg</p>
        </div>

        <!-- Add Weight Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Nieuwe Meting</h3>
          <form id="weight-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                <input 
                  type="date" 
                  id="weight-date" 
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Gewicht (kg)</label>
                <input 
                  type="number" 
                  id="weight-value" 
                  step="0.1" 
                  min="40" 
                  max="200" 
                  required
                  placeholder="86.8"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Notitie (optioneel)</label>
              <input 
                type="text" 
                id="weight-note" 
                placeholder="Bijv: na het douchen, 's ochtends"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
              >
            </div>
            <div class="flex gap-2">
              <button 
                type="submit" 
                class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition"
              >
                üíæ Opslaan
              </button>
              <button 
                type="button"
                onclick="cancelWeightEdit()"
                id="weight-cancel-btn"
                class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition hidden"
              >
                Annuleer
              </button>
            </div>
          </form>
        </div>

        <!-- Weight History -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Geschiedenis</h3>
          <div id="weight-list" class="space-y-2">
            <!-- Weight entries will be inserted here -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Dashboard Section (Chart.js) -->
  <div id="dashboard-section" class="app-section">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4 md:p-8">
      <div class="max-w-7xl mx-auto">
        <!-- Dashboard Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-3xl font-bold text-gray-800">üìä Dashboard</h2>
            </div>
            <div class="flex gap-2">
              <button onclick="refreshDashboard()" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
                üîÑ Ververs
              </button>
              <button onclick="setDashboardDayType('rest')" id="dash-btn-rest" class="px-4 py-2 rounded-lg font-medium transition bg-blue-600 text-white">
                Rustdag
              </button>
              <button onclick="setDashboardDayType('sport')" id="dash-btn-sport" class="px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                Sportdag
              </button>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div class="flex flex-col gap-6">
            
            <!-- Date Range Selector -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-3">Periode Selectie</h3>
              <div class="flex flex-col lg:flex-row gap-3">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Snelle keuze</label>
                  <select id="date-preset" onchange="applyDatePreset()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="7">Laatste 7 dagen</option>
                    <option value="14">Laatste 14 dagen</option>
                    <option value="30">Laatste 30 dagen</option>
                    <option value="90">Laatste 90 dagen</option>
                    <option value="this-week">Deze week</option>
                    <option value="last-week">Vorige week</option>
                    <option value="this-month">Deze maand</option>
                    <option value="last-month">Vorige maand</option>
                    <option value="all">Alles</option>
                    <option value="custom">Aangepast</option>
                  </select>
                </div>
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Van datum</label>
                  <input type="date" id="date-from" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
                </div>
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Tot datum</label>
                  <input type="date" id="date-to" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
                </div>
                <div class="flex items-end">
                  <button onclick="applyCustomDateRange()" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition whitespace-nowrap">
                    Toepassen
                  </button>
                </div>
              </div>
            </div>

            <!-- Time Range Buttons (kept for quick access) -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-3">Snelkeuze</h3>
              <div class="flex gap-2 flex-wrap" id="time-buttons">
                <button onclick="setTimeRange(7)" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-blue-600 text-white" data-days="7">7 dagen</button>
                <button onclick="setTimeRange(14)" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-700 hover:bg-gray-200" data-days="14">14 dagen</button>
                <button onclick="setTimeRange(30)" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-700 hover:bg-gray-200" data-days="30">30 dagen</button>
                <button onclick="setTimeRange(90)" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-700 hover:bg-gray-200" data-days="90">90 dagen</button>
              </div>
            </div>

            <!-- Metric Toggles -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-3">Weergave</h3>
              <div class="flex gap-2 flex-wrap" id="metric-buttons">
                <button onclick="toggleMetric('calories')" class="metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white" style="background-color: #3b82f6" data-metric="calories">Calorie√´n</button>
                <button onclick="toggleMetric('protein')" class="metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white" style="background-color: #10b981" data-metric="protein">Eiwit</button>
                <button onclick="toggleMetric('saturatedFat')" class="metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white" style="background-color: #ef4444" data-metric="saturatedFat">Verzadigd vet</button>
                <button onclick="toggleMetric('fiber')" class="metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white" style="background-color: #f59e0b" data-metric="fiber">Vezels</button>
                <button onclick="toggleMetric('sodium')" class="metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white" style="background-color: #8b5cf6" data-metric="sodium">Natrium</button>
                <button onclick="toggleMetric('weight')" class="metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white" style="background-color: #ec4899" data-metric="weight">Gewicht</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Trends over tijd</h2>
          <div class="mb-2 text-sm text-gray-600">
            <span class="font-medium">Linker Y-as:</span> Calorie√´n & Natrium ‚Ä¢ 
            <span class="font-medium ml-2">Midden Y-as:</span> Eiwit, Vet & Vezels ‚Ä¢
            <span class="font-medium ml-2">Rechter Y-as:</span> Gewicht (kg)
          </div>
          <div style="position: relative; height: 400px;">
            <canvas id="trendsChart"></canvas>
          </div>
        </div>

        <!-- Stats Cards -->
        <div id="stats-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
      </div>
    </div>
  </div>

  <!-- Analysis Section -->
  <div id="analysis-section" class="app-section">
    <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-4 md:p-8">
      <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">üìà Analyse & Trends</h2>
          <p class="text-gray-600">Ontdek patronen en verbeter je gewoontes</p>
        </div>

        <!-- Week-over-Week Comparison -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Week Vergelijking</h3>
          <p class="text-sm text-gray-600 mb-4">Gemiddelden per week - kijk hoe je progressie verloopt</p>
          <div id="week-comparison-table" class="overflow-x-auto">
            <!-- Table will be inserted here -->
          </div>
        </div>

        <!-- Calendar Heatmap -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
            <div>
              <h3 class="text-xl font-bold text-gray-800">üóìÔ∏è Kalender Overzicht</h3>
              <p class="text-sm text-gray-600">Zie in √©√©n oogopslag hoe je het doet</p>
            </div>
            <div class="mt-3 md:mt-0">
              <label class="block text-sm font-medium text-gray-700 mb-2">Toon metric:</label>
              <select id="heatmap-metric" onchange="updateHeatmap()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="calories">Calorie√´n</option>
                <option value="protein">Eiwit</option>
                <option value="saturatedFat">Verzadigd vet</option>
                <option value="fiber">Vezels</option>
                <option value="sodium">Natrium</option>
                <option value="overall">Alles (gemiddelde)</option>
              </select>
            </div>
          </div>
          <div class="mb-3 flex items-center gap-4 text-sm">
            <span class="flex items-center gap-2">
              <span class="w-6 h-6 rounded bg-green-500"></span>
              <span>Goed (binnen target)</span>
            </span>
            <span class="flex items-center gap-2">
              <span class="w-6 h-6 rounded bg-yellow-400"></span>
              <span>Redelijk (net over)</span>
            </span>
            <span class="flex items-center gap-2">
              <span class="w-6 h-6 rounded bg-red-500"></span>
              <span>Boven target</span>
            </span>
            <span class="flex items-center gap-2">
              <span class="w-6 h-6 rounded bg-gray-200"></span>
              <span>Geen data</span>
            </span>
          </div>
          <div id="heatmap-container" class="overflow-x-auto">
            <!-- Heatmap will be inserted here -->
          </div>
        </div>

        <!-- Weekday Trends -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üìà Weekdag Trends</h3>
          <p class="text-sm text-gray-600 mb-4">Ontdek je patronen per dag van de week</p>
          <div id="weekday-trends" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Weekday cards will be inserted here -->
          </div>
        </div>

      </div>
    </div>
  </div>
<!-- Data Section -->
<div id="data-section" class="app-section">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
      <h2 class="text-3xl font-bold mb-6 text-blue-600">üíæ Data Management</h2>
      
      <!-- Local Backup Section -->
      <div class="mb-8">
        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span>üì•</span> Lokale Backup
        </h3>
        <div class="bg-gray-50 rounded-lg p-4">
          <p class="text-sm text-gray-600 mb-4">
            Download je complete data als onversleuteld JSON bestand. 
            Bewaar dit veilig op je eigen computer.
          </p>
          <div class="flex flex-wrap gap-3">
            <button 
              onclick="downloadMainDataFromDataTab()" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
            >
              <span>‚¨áÔ∏è</span> Download Backup
            </button>
            <button 
              onclick="showImportModal()" 
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2"
            >
              <span>‚¨ÜÔ∏è</span> Import Backup
            </button>
          </div>
          <div id="local-backup-status" class="mt-3 text-sm"></div>
        </div>
      </div>

      <!-- Backup Settings Section -->
      <div class="mb-8">
        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span>‚öôÔ∏è</span> Backup Instellingen
        </h3>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <label class="text-sm font-medium text-gray-700">
              Backup herinnering
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input 
                type="checkbox" 
                id="backup-reminder-toggle" 
                class="sr-only peer"
                onchange="toggleBackupReminder()"
              />
              <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>
          
          <div id="backup-reminder-settings" class="hidden">
            <label class="block text-sm text-gray-600 mb-2">
              Herinner me na:
            </label>
            <select 
              id="backup-reminder-days" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              onchange="saveBackupReminderSettings()"
            >
              <option value="7">7 dagen</option>
              <option value="14" selected>14 dagen</option>
              <option value="30">30 dagen</option>
            </select>
            <p class="text-xs text-gray-500 mt-2">
              Een banner verschijnt boven aan de app als je al een tijdje geen backup hebt gemaakt.
            </p>
          </div>

          <div class="mt-4 text-sm text-gray-600">
            <p><strong>Laatste backup:</strong> <span id="last-backup-date">Nooit</span></p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>



  <!-- Settings Section -->
  <div id="settings-section" class="app-section">
    <div class="min-h-screen bg-gradient-to-br from-slate-50 to-gray-50 p-4 md:p-8">
      <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">‚öôÔ∏è Instellingen</h2>
          <p class="text-gray-600">Pas je persoonlijke doelen en limieten aan</p>
        </div>

        <!-- Settings Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <form id="settings-form" class="space-y-6">
            
            <!-- Calorie Goals -->
            <div class="border-b border-gray-200 pb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                üî• Calorie Doelen
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Rustdag (kcal)
                  </label>
                  <input 
                    type="number" 
                    id="setting-calories-rest" 
                    min="1000" 
                    max="5000" 
                    step="50"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks calorie maximum op rustdagen</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Sportdag (kcal)
                  </label>
                  <input 
                    type="number" 
                    id="setting-calories-sport" 
                    min="1000" 
                    max="5000" 
                    step="50"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks calorie maximum op sportdagen</p>
                </div>
              </div>
            </div>

            <!-- Protein Goals -->
            <div class="border-b border-gray-200 pb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                üí™ Eiwit Doelen
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Rustdag (g)
                  </label>
                  <input 
                    type="number" 
                    id="setting-protein-rest" 
                    min="50" 
                    max="300" 
                    step="5"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks eiwit minimum op rustdagen</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Sportdag (g)
                  </label>
                  <input 
                    type="number" 
                    id="setting-protein-sport" 
                    min="50" 
                    max="300" 
                    step="5"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks eiwit minimum op sportdagen</p>
                </div>
              </div>
            </div>

            <!-- Nutrient Limits -->
            <div class="border-b border-gray-200 pb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                üçΩÔ∏è Voedingsstof Limieten
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Verzadigd Vet Max (g)
                  </label>
                  <input 
                    type="number" 
                    id="setting-saturated-fat" 
                    min="5" 
                    max="100" 
                    step="1"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks maximum</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Vezels Min (g)
                  </label>
                  <input 
                    type="number" 
                    id="setting-fiber" 
                    min="10" 
                    max="100" 
                    step="1"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks minimum</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Natrium Max (mg)
                  </label>
                  <input 
                    type="number" 
                    id="setting-sodium" 
                    min="500" 
                    max="5000" 
                    step="100"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p class="text-xs text-gray-500 mt-1">Dagelijks maximum</p>
                </div>
              </div>
            </div>

            <!-- Weight Goal -->
            <div class="pb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                üéØ Gewicht Doel
              </h3>
              <div class="max-w-md">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Streefgewicht (kg)
                </label>
                <input 
                  type="number" 
                  id="setting-target-weight" 
                  min="40" 
                  max="200" 
                  step="0.1"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <p class="text-xs text-gray-500 mt-1">Je gewichtsdoel in kilogram</p>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4">
              <button 
                type="submit" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition shadow-md"
              >
                üíæ Opslaan
              </button>
              <button 
                type="button"
                onclick="resetSettings()"
                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
              >
                üîÑ Reset naar Standaard
              </button>
            </div>
          </form>
        </div>

        <!-- Info Card -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <span class="text-2xl">üí°</span>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">Info</h3>
              <div class="mt-2 text-sm text-blue-700">
                <p>Wijzigingen worden direct toegepast op alle secties (Journaal, Dashboard, Tracking & Analyse).</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- IndexedDB Setup Script -->
  <script>
    // Initialize Dexie database
    function initDatabase() {
      window.db = new Dexie('VoedseljournaalDB');
      window.db.version(1).stores({
        entries: 'id, date, created_at, updated_at',
        products: 'id, name, created_at, updated_at'
      });
      // Version 2: Add weights table
      window.db.version(2).stores({
        entries: 'id, date, created_at, updated_at',
        products: 'id, name, created_at, updated_at',
        weights: 'id, date, created_at'
      });
      // Version 3: Add settings table
      window.db.version(3).stores({
        entries: 'id, date, created_at, updated_at',
        products: 'id, name, created_at, updated_at',
        weights: 'id, date, created_at',
        settings: 'key'
      });

  // Version 4: Placeholder for backward compatibility (was used for cloud sync)
  window.db.version(4).stores({
    entries: 'id, date, created_at, updated_at',
    products: 'id, name, created_at, updated_at',
    weights: 'id, date, created_at',
    settings: 'key'
  });
    }
    
    // Default settings
    const DEFAULT_SETTINGS = {
      caloriesRest: 1900,
      caloriesSport: 2200,
      proteinRest: 110,
      proteinSport: 120,
      saturatedFatMax: 20,
      fiberMin: 35,
      sodiumMax: 2300,
      targetWeight: 78
    };
    
    // Load settings from database
    async function loadSettings() {
      try {
        if (!window.db || !window.db.settings) {
          console.log('Settings table not yet available');
          return DEFAULT_SETTINGS;
        }
        
        const settingsRecord = await window.db.settings.get('user-settings');
        if (settingsRecord && settingsRecord.values) {
          return { ...DEFAULT_SETTINGS, ...settingsRecord.values };
        }
        return DEFAULT_SETTINGS;
      } catch (error) {
        console.error('Error loading settings:', error);
        return DEFAULT_SETTINGS;
      }
    }
    
    // Save settings to database
    async function saveSettings(settings) {
      try {
        if (!window.db || !window.db.settings) {
          console.warn('Settings table not yet available');
          return;
        }
        
        await window.db.settings.put({
          key: 'user-settings',
          values: settings,
          updated_at: new Date().toISOString()
        });
        
        console.log('Settings saved successfully');
        
        // Refresh all sections that use settings
        if (typeof updateDashboard === 'function') updateDashboard();
        if (typeof loadWeights === 'function') loadWeights();
      } catch (error) {
        console.error('Error saving settings:', error);
      }
    }

    // Migration flag
    const MIGRATION_KEY = 'indexeddb_migrated_v2';

    // Migrate localStorage to IndexedDB
    async function migrateFromLocalStorage() {
      if (localStorage.getItem(MIGRATION_KEY)) {
        console.log('Migration already completed');
        return;
      }

      console.log('Starting migration from localStorage to IndexedDB...');
      
      try {
        const now = new Date().toISOString();
        
        // Migrate entries
        const savedEntries = localStorage.getItem('foodJournalEntries');
        if (savedEntries) {
          const entries = JSON.parse(savedEntries);
          const migratedEntries = entries.map(entry => ({
            ...entry,
            created_at: entry.created_at || now,
            updated_at: entry.updated_at || now
          }));
          await window.db.entries.bulkPut(migratedEntries);
          console.log(`Migrated ${migratedEntries.length} entries`);
        }

        // Migrate products
        const savedProducts = localStorage.getItem('foodProductDatabase');
        if (savedProducts) {
          const products = JSON.parse(savedProducts);
          const migratedProducts = products.map(product => ({
            ...product,
            created_at: product.created_at || now,
            updated_at: product.updated_at || now
          }));
          await window.db.products.bulkPut(migratedProducts);
          console.log(`Migrated ${migratedProducts.length} products`);
        }

        // Mark migration as complete
        localStorage.setItem(MIGRATION_KEY, 'true');
        console.log('Migration completed successfully!');
        
        // Optional: Clean up old localStorage data (commented out for safety)
        // localStorage.removeItem('foodJournalEntries');
        // localStorage.removeItem('foodProductDatabase');
        
      } catch (error) {
        console.error('Migration failed:', error);
      }
    }

    // Initialize database and run migration on page load
    window.addEventListener('DOMContentLoaded', async function() {
      initDatabase();
      
      // Open database to ensure it's fully initialized
      try {
        await window.db.open();
        console.log('Database initialized successfully');
        
        // Now safe to call database-dependent functions
        if (typeof checkBackupReminder === 'function') {
          checkBackupReminder();
        }
      } catch (error) {
        console.error('Database initialization error:', error);
      }
      
      migrateFromLocalStorage();
    });
  </script>

  <!-- Tab Switching Script -->
  <script>
    function switchTab(tab) {
      // Hide all sections
      document.querySelectorAll('.app-section').forEach(section => {
        section.classList.remove('active');
      });

      // Reset all buttons
      document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
        btn.className = 'px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300 text-base sm:text-base';
      });

      // Show selected section
      document.getElementById(tab + '-section').classList.add('active');
      
      // Highlight active button
      document.getElementById('tab-' + tab).className = 'px-3 sm:px-4 py-2 font-semibold rounded-lg transition-all bg-blue-600 text-white text-base sm:text-base';

      // Save preference
      localStorage.setItem('activeTab', tab);

      // If switching to dashboard, refresh it
      if (tab === 'dashboard' && typeof updateDashboard === 'function') {
        updateDashboard();
      }
      
      // If switching to tracking, load weights
      if (tab === 'tracking' && typeof loadWeights === 'function') {
        loadWeights();
      }
      
      // If switching to analysis, update analysis
      if (tab === 'analysis' && typeof updateAnalysis === 'function') {
        updateAnalysis();
      }
      
      // If switching to settings, load settings
      if (tab === 'settings' && typeof loadSettingsForm === 'function') {
        loadSettingsForm();
      }
      
      // If switching to data, load data tab
      if (tab === 'data' && typeof loadDataTab === 'function') {
        loadDataTab();
      }
    }

    // Restore last active tab
    window.addEventListener('DOMContentLoaded', function() {
      const lastTab = localStorage.getItem('activeTab');
      if (lastTab && ['dashboard', 'tracking', 'analysis', 'settings', 'data'].includes(lastTab)) {
        switchTab(lastTab);
      }
    });
  </script>

  <!-- Weight Tracking Script -->
  <script>
    let editingWeightId = null;

    // Initialize weight form
    document.addEventListener('DOMContentLoaded', function() {
      // Set default date to today
      document.getElementById('weight-date').valueAsDate = new Date();
      
      // Handle form submit
      document.getElementById('weight-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveWeight();
      });
    });

    async function saveWeight() {
      const date = document.getElementById('weight-date').value;
      const weight = parseFloat(document.getElementById('weight-value').value);
      const note = document.getElementById('weight-note').value.trim();

      if (!date || !weight) {
        alert('Vul datum en gewicht in');
        return;
      }

      const weightData = {
        date: date,
        weight: weight,
        note: note,
        created_at: new Date().toISOString()
      };

      try {
        if (editingWeightId) {
          // Update existing
          weightData.id = editingWeightId;
          await window.db.weights.put(weightData);
          editingWeightId = null;
          document.getElementById('weight-cancel-btn').classList.add('hidden');
        } else {
          // Add new
          weightData.id = Date.now().toString();
          await window.db.weights.add(weightData);
        }

        // Reset form
        document.getElementById('weight-form').reset();
        document.getElementById('weight-date').valueAsDate = new Date();
        
        // Reload list
        await loadWeights();
      } catch (error) {
        console.error('Error saving weight:', error);
        alert('Fout bij opslaan: ' + error.message);
      }
    }

    async function loadWeights() {
      try {
        const weights = await window.db.weights.orderBy('date').reverse().toArray();
        
        // Load settings for target weight
        const settings = await loadSettings();
        const targetWeight = settings.targetWeight;
        
        // Update target weight display
        document.getElementById('target-weight').textContent = targetWeight.toFixed(1);
        
        // Update header stats
        if (weights.length > 0) {
          const latest = weights[0];
          const toGo = (latest.weight - targetWeight).toFixed(1);
          
          document.getElementById('current-weight').textContent = latest.weight.toFixed(1);
          document.getElementById('weight-to-go').textContent = toGo;
        } else {
          document.getElementById('current-weight').textContent = '--';
          document.getElementById('weight-to-go').textContent = '--';
        }

        // Render list
        const listEl = document.getElementById('weight-list');
        
        if (weights.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500 text-center py-4">Nog geen metingen toegevoegd</p>';
          return;
        }

        listEl.innerHTML = weights.map(w => {
          const weightChange = weights.length > 1 ? calculateWeightChange(w, weights) : null;
          const changeHtml = weightChange ? 
            `<span class="text-sm ${weightChange > 0 ? 'text-red-600' : 'text-green-600'}">
              ${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)} kg
            </span>` : '';

          return `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
              <div class="flex-1">
                <div class="flex items-center gap-3">
                  <span class="text-lg font-bold text-gray-800">${w.weight.toFixed(1)} kg</span>
                  ${changeHtml}
                  <span class="text-sm text-gray-500">${formatDate(w.date)}</span>
                </div>
                ${w.note ? `<p class="text-sm text-gray-600 mt-1">${w.note}</p>` : ''}
              </div>
              <div class="flex gap-2">
                <button onclick="editWeight('${w.id}')" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">
                  ‚úèÔ∏è Bewerk
                </button>
                <button onclick="deleteWeight('${w.id}')" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                  üóëÔ∏è Verwijder
                </button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading weights:', error);
      }
    }

    function calculateWeightChange(currentWeight, allWeights) {
      const currentIndex = allWeights.findIndex(w => w.id === currentWeight.id);
      if (currentIndex >= allWeights.length - 1) return null;
      
      const previousWeight = allWeights[currentIndex + 1];
      return currentWeight.weight - previousWeight.weight;
    }

    async function editWeight(id) {
      try {
        const weight = await window.db.weights.get(id);
        if (!weight) return;

        editingWeightId = id;
        document.getElementById('weight-date').value = weight.date;
        document.getElementById('weight-value').value = weight.weight;
        document.getElementById('weight-note').value = weight.note || '';
        document.getElementById('weight-cancel-btn').classList.remove('hidden');
        
        // Scroll to form
        document.getElementById('weight-form').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error editing weight:', error);
      }
    }

    function cancelWeightEdit() {
      editingWeightId = null;
      document.getElementById('weight-form').reset();
      document.getElementById('weight-date').valueAsDate = new Date();
      document.getElementById('weight-cancel-btn').classList.add('hidden');
    }

    async function deleteWeight(id) {
      if (!confirm('Weet je zeker dat je deze meting wilt verwijderen?')) return;

      try {
        await window.db.weights.delete(id);
        await loadWeights();
      } catch (error) {
        console.error('Error deleting weight:', error);
        alert('Fout bij verwijderen: ' + error.message);
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const options = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
      return date.toLocaleDateString('nl-NL', options);
    }

    window.loadWeights = loadWeights;
  </script>

  <!-- Settings Form Script -->
  <script>
    // Load settings into form
    async function loadSettingsForm() {
      const settings = await loadSettings();
      
      document.getElementById('setting-calories-rest').value = settings.caloriesRest;
      document.getElementById('setting-calories-sport').value = settings.caloriesSport;
      document.getElementById('setting-protein-rest').value = settings.proteinRest;
      document.getElementById('setting-protein-sport').value = settings.proteinSport;
      document.getElementById('setting-saturated-fat').value = settings.saturatedFatMax;
      document.getElementById('setting-fiber').value = settings.fiberMin;
      document.getElementById('setting-sodium').value = settings.sodiumMax;
      document.getElementById('setting-target-weight').value = settings.targetWeight;
    }
    
    // Handle settings form submit
    document.addEventListener('DOMContentLoaded', function() {
      const settingsForm = document.getElementById('settings-form');
      if (settingsForm) {
        settingsForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const settings = {
            caloriesRest: parseInt(document.getElementById('setting-calories-rest').value),
            caloriesSport: parseInt(document.getElementById('setting-calories-sport').value),
            proteinRest: parseInt(document.getElementById('setting-protein-rest').value),
            proteinSport: parseInt(document.getElementById('setting-protein-sport').value),
            saturatedFatMax: parseInt(document.getElementById('setting-saturated-fat').value),
            fiberMin: parseInt(document.getElementById('setting-fiber').value),
            sodiumMax: parseInt(document.getElementById('setting-sodium').value),
            targetWeight: parseFloat(document.getElementById('setting-target-weight').value)
          };
          
          await saveSettings(settings);
          
          // Show success message
          const submitBtn = settingsForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = '‚úì Opgeslagen!';
          submitBtn.className = 'px-6 py-3 bg-green-600 text-white rounded-lg font-semibold transition shadow-md';
          
          setTimeout(() => {
            submitBtn.textContent = originalText;
            submitBtn.className = 'px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition shadow-md';
          }, 2000);
        });
      }
    });
    
    // Reset settings to defaults
    async function resetSettings() {
      if (!confirm('Weet je zeker dat je alle instellingen wilt resetten naar de standaardwaarden?')) {
        return;
      }
      
      await saveSettings(DEFAULT_SETTINGS);
      await loadSettingsForm();
      
      alert('Instellingen zijn gereset naar standaardwaarden!');
    }
    
    window.loadSettingsForm = loadSettingsForm;
  </script>

  <!-- Food Journal React Component -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    function FoodJournal() {
      const [entries, setEntries] = useState([]);
      const [products, setProducts] = useState([]);
      const [settings, setSettings] = useState(null);
      const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
      const [isSportDay, setIsSportDay] = useState(false);
      const [showAddMeal, setShowAddMeal] = useState(false);
      const [showReport, setShowReport] = useState(false);
      const [reportDays, setReportDays] = useState(14);
      const [showProducts, setShowProducts] = useState(false);
      const [showAddProduct, setShowAddProduct] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const [mealTab, setMealTab] = useState('products');
      const [productTab, setProductTab] = useState('manual');

      // Meal form states
      const [mealTime, setMealTime] = useState('');
      const [selectedProducts, setSelectedProducts] = useState([]);
      const [productGrams, setProductGrams] = useState({});
      const [productSearch, setProductSearch] = useState('');
      
      // Manual meal form
      const [manualMeal, setManualMeal] = useState({
        time: '', name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: ''
      });

      // JSON imports
      const [mealJson, setMealJson] = useState('');
      const [productJson, setProductJson] = useState('');

      // Product form
      const [newProduct, setNewProduct] = useState({
        name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: '', favorite: false
      });

      const [productSearchDb, setProductSearchDb] = useState('');
      const [productSort, setProductSort] = useState('favorite');

      // Load settings
      useEffect(() => {
        loadSettings().then(loadedSettings => {
          setSettings(loadedSettings);
        });
      }, []);

      // Load from IndexedDB
      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        try {
          // Wait for db to be initialized
          if (!window.db) {
            console.log('Waiting for database initialization...');
            setTimeout(loadData, 100);
            return;
          }
          const loadedEntries = await window.db.entries.toArray();
          const loadedProducts = await window.db.products.toArray();
          setEntries(loadedEntries);
          setProducts(loadedProducts);
        } catch (error) {
          console.error('Error loading data:', error);
        }
      };

      // Save entries to IndexedDB when they change
      useEffect(() => {
        if (entries.length > 0) {
          saveEntries();
        }
      }, [entries]);

      // Save products to IndexedDB when they change
      useEffect(() => {
        if (products.length > 0) {
          saveProducts();
        }
      }, [products]);

      const saveEntries = async () => {
        try {
          await window.db.entries.bulkPut(entries);
        } catch (error) {
          console.error('Error saving entries:', error);
        }
      };

      const saveProducts = async () => {
        try {
          await window.db.products.bulkPut(products);
        } catch (error) {
          console.error('Error saving products:', error);
        }
      };

      // Download function with CSP workaround
      const downloadBase64 = (content, filename) => {
        const utf8Bytes = new TextEncoder().encode(content);
        let binaryString = '';
        utf8Bytes.forEach(byte => {
          binaryString += String.fromCharCode(byte);
        });
        const base64 = btoa(binaryString);
        
        const dataUri = 'data:text/plain;charset=utf-8;base64,' + base64;
        const a = document.createElement('a');
        a.href = dataUri;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      const downloadReport = () => {
        downloadBase64(getDetailedReportText(), `voedseljournaal_${new Date().toISOString().split('T')[0]}.txt`);
      };

      const downloadPdfReport = () => {
        generatePdfReport(entries, reportDays);
      };

      // Get today's entries
      const todayEntries = entries
        .filter(e => e.date === selectedDate)
        .sort((a, b) => a.time.localeCompare(b.time));

      // Calculate totals
      const totals = todayEntries.reduce((acc, entry) => ({
        calories: acc.calories + entry.calories,
        protein: acc.protein + entry.protein,
        fat: acc.fat + entry.fat,
        saturatedFat: acc.saturatedFat + entry.saturatedFat,
        fiber: acc.fiber + entry.fiber,
        sodium: acc.sodium + entry.sodium
      }), { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 });

      // Use settings if loaded, otherwise use defaults
      const currentSettings = settings || DEFAULT_SETTINGS;
      const goals = isSportDay 
        ? { calories: currentSettings.caloriesSport, protein: currentSettings.proteinSport }
        : { calories: currentSettings.caloriesRest, protein: currentSettings.proteinRest };
      const limits = {
        saturatedFat: currentSettings.saturatedFatMax,
        fiber: currentSettings.fiberMin,
        sodium: currentSettings.sodiumMax
      };

      // Add meal via products
      const addMealFromProducts = () => {
        if (selectedProducts.length === 0) return;

        const time = mealTime || new Date().toTimeString().slice(0, 5);
        let totals = { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 };
        const productDetails = [];

        selectedProducts.forEach(prodName => {
          const product = products.find(p => p.name === prodName);
          const grams = productGrams[prodName] || 100;
          const multiplier = grams / 100;

          totals.calories += product.calories * multiplier;
          totals.protein += product.protein * multiplier;
          totals.fat += product.fat * multiplier;
          totals.saturatedFat += product.saturatedFat * multiplier;
          totals.fiber += product.fiber * multiplier;
          totals.sodium += product.sodium * multiplier;

          productDetails.push({ name: prodName, grams });
        });

        const name = productDetails.map(p => `${p.name} (${p.grams}g)`).join(' + ');
        const now = new Date().toISOString();

        const entry = {
          id: Date.now() + Math.random(),
          date: selectedDate,
          time,
          name,
          products: productDetails,
          calories: Math.round(totals.calories),
          protein: parseFloat(totals.protein.toFixed(1)),
          fat: parseFloat(totals.fat.toFixed(1)),
          saturatedFat: parseFloat(totals.saturatedFat.toFixed(1)),
          fiber: parseFloat(totals.fiber.toFixed(1)),
          sodium: Math.round(totals.sodium),
          created_at: now,
          updated_at: now
        };

        setEntries([...entries, entry]);
        resetMealForm();
      };

      // Add meal manually
      const addMealManually = () => {
        const now = new Date().toISOString();
        const entry = {
          id: Date.now() + Math.random(),
          date: selectedDate,
          time: manualMeal.time || new Date().toTimeString().slice(0, 5),
          name: manualMeal.name,
          calories: parseInt(manualMeal.calories) || 0,
          protein: parseFloat(manualMeal.protein) || 0,
          fat: parseFloat(manualMeal.fat) || 0,
          saturatedFat: parseFloat(manualMeal.saturatedFat) || 0,
          fiber: parseFloat(manualMeal.fiber) || 0,
          sodium: parseInt(manualMeal.sodium) || 0,
          created_at: now,
          updated_at: now
        };

        setEntries([...entries, entry]);
        resetMealForm();
      };

      // Import meal from JSON
      const importMealJson = () => {
        try {
          const data = JSON.parse(mealJson);
          const now = new Date().toISOString();
          const entry = {
            id: Date.now() + Math.random(),
            date: selectedDate,
            time: data.time || new Date().toTimeString().slice(0, 5),
            name: data.name || 'Ge√Ømporteerde maaltijd',
            calories: parseInt(data.calories) || 0,
            protein: parseFloat(data.protein) || 0,
            fat: parseFloat(data.fat) || 0,
            saturatedFat: parseFloat(data.saturatedFat) || 0,
            fiber: parseFloat(data.fiber) || 0,
            sodium: parseInt(data.sodium) || 0,
            created_at: now,
            updated_at: now
          };
          setEntries([...entries, entry]);
          resetMealForm();
        } catch (e) {
          alert('Ongeldige JSON');
        }
      };

      const deleteMeal = async (id) => {
        if (confirm('Verwijder deze maaltijd?')) {
          const newEntries = entries.filter(e => e.id !== id);
          setEntries(newEntries);
          try {
            await window.db.entries.delete(id);
          } catch (error) {
            console.error('Error deleting entry:', error);
          }
        }
      };

      const resetMealForm = () => {
        setShowAddMeal(false);
        setMealTime('');
        setSelectedProducts([]);
        setProductGrams({});
        setProductSearch('');
        setManualMeal({ time: '', name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: '' });
        setMealJson('');
      };

      // Product management
      const addProduct = () => {
        if (!newProduct.name) return;
        const now = new Date().toISOString();
        const product = {
          id: Date.now() + Math.random(),
          name: newProduct.name,
          calories: parseFloat(newProduct.calories) || 0,
          protein: parseFloat(newProduct.protein) || 0,
          fat: parseFloat(newProduct.fat) || 0,
          saturatedFat: parseFloat(newProduct.saturatedFat) || 0,
          fiber: parseFloat(newProduct.fiber) || 0,
          sodium: parseInt(newProduct.sodium) || 0,
          favorite: newProduct.favorite,
          created_at: now,
          updated_at: now
        };
        setProducts([...products, product]);
        setNewProduct({ name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: '', favorite: false });
        setShowAddProduct(false);
      };

      const deleteProduct = async (id) => {
        if (confirm('Verwijder dit product?')) {
          const newProducts = products.filter(p => p.id !== id);
          setProducts(newProducts);
          try {
            await window.db.products.delete(id);
          } catch (error) {
            console.error('Error deleting product:', error);
          }
        }
      };

      const toggleFavorite = (id) => {
        const now = new Date().toISOString();
        setProducts(products.map(p => 
          p.id === id ? { ...p, favorite: !p.favorite, updated_at: now } : p
        ));
      };

      const startEditProduct = (product) => {
        setEditingProduct(product);
        setNewProduct(product);
        setShowAddProduct(true);
      };

      const updateProduct = () => {
        if (!newProduct.name) return;
        const now = new Date().toISOString();
        setProducts(products.map(p => 
          p.id === editingProduct.id 
            ? { ...newProduct, id: editingProduct.id, updated_at: now, created_at: p.created_at } 
            : p
        ));
        setEditingProduct(null);
        setNewProduct({ name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: '', favorite: false });
        setShowAddProduct(false);
      };

      const cancelEditProduct = () => {
        setEditingProduct(null);
        setNewProduct({ name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: '', favorite: false });
        setShowAddProduct(false);
      };

      // Import product from JSON with smart merge
      const importProductJson = () => {
        try {
          const data = JSON.parse(productJson);
          const now = new Date().toISOString();
          
          if (Array.isArray(data)) {
            let addedCount = 0;
            let updatedCount = 0;
            const newProducts = [...products];
            
            data.forEach(prod => {
              const productName = prod.name || 'Nieuw product';
              const existingIndex = newProducts.findIndex(p => 
                p.name.toLowerCase() === productName.toLowerCase()
              );
              
              const productData = {
                name: productName,
                calories: parseFloat(prod.calories) || 0,
                protein: parseFloat(prod.protein) || 0,
                fat: parseFloat(prod.fat) || 0,
                saturatedFat: parseFloat(prod.saturatedFat) || 0,
                fiber: parseFloat(prod.fiber) || 0,
                sodium: parseInt(prod.sodium) || 0,
                favorite: prod.favorite || false
              };
              
              if (existingIndex >= 0) {
                newProducts[existingIndex] = {
                  ...productData,
                  id: newProducts[existingIndex].id,
                  favorite: newProducts[existingIndex].favorite,
                  created_at: newProducts[existingIndex].created_at,
                  updated_at: now
                };
                updatedCount++;
              } else {
                newProducts.push({
                  ...productData,
                  id: Date.now() + Math.random(),
                  created_at: now,
                  updated_at: now
                });
                addedCount++;
              }
            });
            
            setProducts(newProducts);
            alert(`${addedCount} producten toegevoegd, ${updatedCount} bijgewerkt!`);
          } else {
            const productName = data.name || 'Nieuw product';
            const existingIndex = products.findIndex(p => 
              p.name.toLowerCase() === productName.toLowerCase()
            );
            
            const productData = {
              name: productName,
              calories: parseFloat(data.calories) || 0,
              protein: parseFloat(data.protein) || 0,
              fat: parseFloat(data.fat) || 0,
              saturatedFat: parseFloat(data.saturatedFat) || 0,
              fiber: parseFloat(data.fiber) || 0,
              sodium: parseInt(data.sodium) || 0,
              favorite: data.favorite || false
            };
            
            if (existingIndex >= 0) {
              const newProducts = [...products];
              newProducts[existingIndex] = {
                ...productData,
                id: products[existingIndex].id,
                favorite: products[existingIndex].favorite,
                created_at: products[existingIndex].created_at,
                updated_at: now
              };
              setProducts(newProducts);
              alert('Product bijgewerkt!');
            } else {
              const product = {
                ...productData,
                id: Date.now() + Math.random(),
                created_at: now,
                updated_at: now
              };
              setProducts([...products, product]);
              alert('Product toegevoegd!');
            }
          }
          
          setProductJson('');
          setProductTab('manual');
        } catch (e) {
          alert('Ongeldige JSON');
        }
      };


      // Report generation - last N days table
      const getReportData = (days = 14) => {
        const dateGroups = {};
        entries.forEach(entry => {
          if (!dateGroups[entry.date]) {
            dateGroups[entry.date] = [];
          }
          dateGroups[entry.date].push(entry);
        });

        const dailyTotals = Object.keys(dateGroups)
          .map(date => {
            const dayEntries = dateGroups[date];
            const totals = dayEntries.reduce((acc, e) => ({
              calories: acc.calories + e.calories,
              protein: acc.protein + e.protein,
              fat: acc.fat + e.fat,
              saturatedFat: acc.saturatedFat + e.saturatedFat,
              fiber: acc.fiber + e.fiber,
              sodium: acc.sodium + e.sodium
            }), { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 });
            
            return {
              date,
              ...totals
            };
          })
          .sort((a, b) => b.date.localeCompare(a.date))
          .slice(0, days);

        return dailyTotals;
      };

      const getDetailedReportText = () => {
        const dateGroups = {};
        entries.forEach(entry => {
          if (!dateGroups[entry.date]) {
            dateGroups[entry.date] = [];
          }
          dateGroups[entry.date].push(entry);
        });

        const relevantDates = Object.keys(dateGroups)
          .sort()
          .reverse()
          .slice(0, reportDays);

        let report = `VOEDSELJOURNAAL RAPPORT - LAATSTE ${reportDays} DAGEN\n`;
        report += '='.repeat(60) + '\n\n';

        relevantDates.forEach(date => {
          const dayEntries = dateGroups[date].sort((a, b) => a.time.localeCompare(b.time));
          const dayTotals = dayEntries.reduce((acc, e) => ({
            calories: acc.calories + e.calories,
            protein: acc.protein + e.protein,
            fat: acc.fat + e.fat,
            saturatedFat: acc.saturatedFat + e.saturatedFat,
            fiber: acc.fiber + e.fiber,
            sodium: acc.sodium + e.sodium
          }), { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 });

          report += `üìÖ ${date}\n`;
          report += '-'.repeat(60) + '\n';
          dayEntries.forEach(entry => {
            report += `${entry.time} - ${entry.name}\n`;
            report += `  Kcal: ${entry.calories}, Eiwit: ${entry.protein}g, Vet: ${entry.fat}g, `;
            report += `Verz.vet: ${entry.saturatedFat}g, Vezels: ${entry.fiber}g, Natrium: ${entry.sodium}mg\n`;
          });
          report += `\nDag totaal:\n`;
          report += `  Calorie√´n: ${dayTotals.calories} kcal\n`;
          report += `  Eiwit: ${dayTotals.protein.toFixed(1)}g\n`;
          report += `  Vet: ${dayTotals.fat.toFixed(1)}g\n`;
          report += `  Verzadigd vet: ${dayTotals.saturatedFat.toFixed(1)}g\n`;
          report += `  Vezels: ${dayTotals.fiber.toFixed(1)}g\n`;
          report += `  Natrium: ${dayTotals.sodium}mg\n`;
          report += '\n\n';
        });

        // Voeg gemiddelden toe
        const data = getReportData(reportDays);
        if (data.length > 0) {
          const avg = {
            calories: Math.round(data.reduce((sum, d) => sum + d.calories, 0) / data.length),
            protein: (data.reduce((sum, d) => sum + d.protein, 0) / data.length).toFixed(1),
            fat: (data.reduce((sum, d) => sum + d.fat, 0) / data.length).toFixed(1),
            saturatedFat: (data.reduce((sum, d) => sum + d.saturatedFat, 0) / data.length).toFixed(1),
            fiber: (data.reduce((sum, d) => sum + d.fiber, 0) / data.length).toFixed(1),
            sodium: Math.round(data.reduce((sum, d) => sum + d.sodium, 0) / data.length)
          };
          
          report += '='.repeat(60) + '\n';
          report += 'GEMIDDELDEN OVER DEZE PERIODE\n';
          report += '='.repeat(60) + '\n';
          report += `Calorie√´n:     ${avg.calories} kcal\n`;
          report += `Eiwit:         ${avg.protein}g\n`;
          report += `Vet:           ${avg.fat}g\n`;
          report += `Verzadigd vet: ${avg.saturatedFat}g\n`;
          report += `Vezels:        ${avg.fiber}g\n`;
          report += `Natrium:       ${avg.sodium}mg\n`;
        }

        return report;
      };

      // Filter and sort products
      const filteredProducts = products
        .filter(p => 
          productSearchDb === '' || 
          p.name.toLowerCase().includes(productSearchDb.toLowerCase())
        )
        .sort((a, b) => {
          if (productSort === 'favorite') {
            if (a.favorite !== b.favorite) return a.favorite ? -1 : 1;
            return a.name.localeCompare(b.name);
          } else if (productSort === 'name-asc') {
            return a.name.localeCompare(b.name);
          } else if (productSort === 'name-desc') {
            return b.name.localeCompare(a.name);
          } else if (productSort === 'calories') {
            return b.calories - a.calories;
          } else if (productSort === 'protein') {
            return b.protein - a.protein;
          } else if (productSort === 'sodium') {
            return b.sodium - a.sodium;
          }
          return 0;
        });

      // Filter products for meal selection
      const filteredMealProducts = products
        .filter(p => 
          productSearch === '' || 
          p.name.toLowerCase().includes(productSearch.toLowerCase())
        )
        .sort((a, b) => {
          if (a.favorite !== b.favorite) return a.favorite ? -1 : 1;
          return a.name.localeCompare(b.name);
        });

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
          <div className="max-w-4xl mx-auto">
            {/* Main Dashboard Card */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              {/* Date Selector and Day Type */}
              <div className="flex flex-row gap-3 mb-6">
                <div className="flex-1 min-w-0">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Datum</label>
                  <input
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div className="flex items-end flex-shrink-0">
                  <button
                    onClick={() => setIsSportDay(!isSportDay)}
                    className={`px-3 sm:px-4 py-2 rounded-lg font-medium transition flex items-center gap-1 sm:gap-2 whitespace-nowrap text-sm sm:text-base ${isSportDay ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                  >
                    {isSportDay ? 'üí™' : 'üò¥'} {isSportDay ? 'Sportdag' : 'Rustdag'}
                  </button>
                </div>
              </div>

              {/* Totals Display */}
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <div className="text-sm text-gray-600">Calorie√´n</div>
                  <div className={`text-2xl font-bold ${totals.calories > goals.calories ? 'text-red-600' : 'text-blue-600'}`}>
                    {totals.calories}
                  </div>
                  <div className="text-xs text-gray-500">Max: {goals.calories}</div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg">
                  <div className="text-sm text-gray-600">Eiwit</div>
                  <div className={`text-2xl font-bold ${totals.protein < goals.protein ? 'text-orange-600' : 'text-green-600'}`}>
                    {totals.protein.toFixed(1)}g
                  </div>
                  <div className="text-xs text-gray-500">Doel: {goals.protein}g</div>
                </div>
                <div className="bg-orange-50 p-4 rounded-lg">
                  <div className="text-sm text-gray-600">Vezels</div>
                  <div className={`text-2xl font-bold ${totals.fiber < limits.fiber ? 'text-orange-600' : 'text-green-600'}`}>
                    {totals.fiber.toFixed(1)}g
                  </div>
                  <div className="text-xs text-gray-500">Min: {limits.fiber}g</div>
                </div>
                <div className="bg-red-50 p-4 rounded-lg">
                  <div className="text-sm text-gray-600">Verzadigd vet</div>
                  <div className={`text-2xl font-bold ${totals.saturatedFat > limits.saturatedFat ? 'text-red-600' : 'text-green-600'}`}>
                    {totals.saturatedFat.toFixed(1)}g
                  </div>
                  <div className="text-xs text-gray-500">Max: {limits.saturatedFat}g</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg">
                  <div className="text-sm text-gray-600">Natrium</div>
                  <div className={`text-2xl font-bold ${totals.sodium > limits.sodium ? 'text-red-600' : 'text-green-600'}`}>
                    {totals.sodium}mg
                  </div>
                  <div className="text-xs text-gray-500">Max: {limits.sodium}mg</div>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-sm text-gray-600">Totaal vet</div>
                  <div className="text-2xl font-bold text-gray-700">
                    {totals.fat.toFixed(1)}g
                  </div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={() => setShowAddMeal(true)}
                  className="flex-1 sm:flex-none px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition shadow-md"
                >
                  ‚ûï Maaltijd toevoegen
                </button>
                <button
                  onClick={() => setShowProducts(true)}
                  className="flex-1 sm:flex-none px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition shadow-md"
                >
                  üì¶ Producten beheren
                </button>
                <button
                  onClick={() => setShowReport(!showReport)}
                  className="flex-1 sm:flex-none px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition shadow-md"
                >
                  üìà Rapport
                </button>
              </div>
            </div>

            {/* Today's Meals */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Maaltijden vandaag</h2>
              {todayEntries.length === 0 ? (
                <p className="text-gray-500 text-center py-8">Nog geen maaltijden toegevoegd voor deze dag</p>
              ) : (
                <div className="space-y-3">
                  {todayEntries.map(entry => (
                    <div key={entry.id} className="bg-gray-50 p-4 rounded-lg hover:bg-gray-100 transition">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-semibold text-gray-800">{entry.time} - {entry.name}</div>
                          <div className="text-xs text-gray-500 mt-1">
                            {entry.calories} kcal ‚Ä¢ {entry.protein}g eiwit ‚Ä¢ {entry.fat}g vet ‚Ä¢ {entry.saturatedFat}g verz.vet ‚Ä¢ {entry.fiber}g vezel ‚Ä¢ {entry.sodium}mg natrium
                          </div>
                        </div>
                        <button
                          onClick={() => deleteMeal(entry.id)}
                          className="text-red-600 hover:text-red-800 font-bold"
                        >
                          ‚úï
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Add Meal Modal */}
            {showAddMeal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full sm:max-w-2xl max-h-[95vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b p-3 sm:p-4 flex justify-between items-center">
                    <h3 className="text-lg sm:text-xl font-bold text-gray-800">Maaltijd toevoegen</h3>
                    <button onClick={resetMealForm} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                  </div>
                  
                  <div className="p-3 sm:p-6">
                    {/* Tab Selection */}
                    <div className="flex gap-2 mb-4">
                      <button
                        onClick={() => setMealTab('products')}
                        className={`flex-1 px-2 sm:px-4 py-2 rounded-lg font-medium transition text-xs sm:text-base ${mealTab === 'products' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                      >
                        Producten
                      </button>
                      <button
                        onClick={() => setMealTab('manual')}
                        className={`flex-1 px-2 sm:px-4 py-2 rounded-lg font-medium transition text-xs sm:text-base ${mealTab === 'manual' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                      >
                        Handmatig
                      </button>
                      <button
                        onClick={() => setMealTab('json')}
                        className={`flex-1 px-2 sm:px-4 py-2 rounded-lg font-medium transition text-xs sm:text-base ${mealTab === 'json' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                      >
                        JSON
                      </button>
                    </div>

                    {/* Products Tab */}
                    {mealTab === 'products' && (
                      <div>
                        <div className="mb-4">
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Tijd (optioneel)</label>
                          <input
                            type="time"
                            value={mealTime}
                            onChange={(e) => setMealTime(e.target.value)}
                            className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Producten selecteren:</label>
                          <input
                            type="text"
                            value={productSearch}
                            onChange={(e) => setProductSearch(e.target.value)}
                            placeholder="Zoek product..."
                            className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base mb-2"
                          />
                          <div className="space-y-1 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                            {filteredMealProducts.map(product => (
                              <label key={product.id} className="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer transition text-xs sm:text-sm">
                                <input
                                  type="checkbox"
                                  checked={selectedProducts.includes(product.name)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setSelectedProducts([...selectedProducts, product.name]);
                                      if (!productGrams[product.name]) {
                                        setProductGrams({...productGrams, [product.name]: 100});
                                      }
                                    } else {
                                      setSelectedProducts(selectedProducts.filter(p => p !== product.name));
                                      const newGrams = {...productGrams};
                                      delete newGrams[product.name];
                                      setProductGrams(newGrams);
                                    }
                                  }}
                                  className="w-4 h-4 flex-shrink-0"
                                />
                                <span className="flex-1 min-w-0">
                                  {product.favorite && '‚≠ê '}
                                  {product.name}
                                </span>
                              </label>
                            ))}
                          </div>
                        </div>

                        {/* Selected Products Section */}
                        {selectedProducts.length > 0 && (
                          <div className="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Geselecteerde producten ({selectedProducts.length}):</h4>
                            <div className="space-y-2">
                              {selectedProducts.map(prodName => {
                                const product = products.find(p => p.name === prodName);
                                if (!product) return null;
                                return (
                                  <div key={prodName} className="flex items-center gap-2 bg-white rounded p-2 text-xs sm:text-sm">
                                    <span className="flex-1 font-medium text-gray-800">{prodName}</span>
                                    <input
                                      type="number"
                                      value={productGrams[prodName] || 100}
                                      onChange={(e) => setProductGrams({...productGrams, [prodName]: parseInt(e.target.value) || 100})}
                                      className="w-16 sm:w-20 px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm text-center"
                                      min="1"
                                    />
                                    <span className="text-gray-600">g</span>
                                    <button
                                      onClick={() => {
                                        setSelectedProducts(selectedProducts.filter(p => p !== prodName));
                                        const newGrams = {...productGrams};
                                        delete newGrams[prodName];
                                        setProductGrams(newGrams);
                                      }}
                                      className="text-red-600 hover:text-red-800 font-bold text-lg"
                                    >
                                      ‚úï
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}

                        <button
                          onClick={addMealFromProducts}
                          disabled={selectedProducts.length === 0}
                          className={`w-full px-3 sm:px-4 py-2 rounded-lg font-semibold text-sm sm:text-base transition ${
                            selectedProducts.length === 0 
                              ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                              : 'bg-green-600 text-white hover:bg-green-700'
                          }`}
                        >
                          Maaltijd toevoegen {selectedProducts.length > 0 && `(${selectedProducts.length} product${selectedProducts.length !== 1 ? 'en' : ''})`}
                        </button>
                      </div>
                    )}

                    {/* Manual Tab */}
                    {mealTab === 'manual' && (
                      <div className="space-y-3">
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Tijd</label>
                          <input
                            type="time"
                            value={manualMeal.time}
                            onChange={(e) => setManualMeal({...manualMeal, time: e.target.value})}
                            className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Naam</label>
                          <input
                            type="text"
                            value={manualMeal.name}
                            onChange={(e) => setManualMeal({...manualMeal, name: e.target.value})}
                            className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-2 sm:gap-3">
                          <div>
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Calorie√´n</label>
                            <input
                              type="number"
                              value={manualMeal.calories}
                              onChange={(e) => setManualMeal({...manualMeal, calories: e.target.value})}
                              className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                            />
                          </div>
                          <div>
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Eiwit (g)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={manualMeal.protein}
                              onChange={(e) => setManualMeal({...manualMeal, protein: e.target.value})}
                              className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                            />
                          </div>
                          <div>
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Vet (g)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={manualMeal.fat}
                              onChange={(e) => setManualMeal({...manualMeal, fat: e.target.value})}
                              className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                            />
                          </div>
                          <div>
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Verzadigd vet (g)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={manualMeal.saturatedFat}
                              onChange={(e) => setManualMeal({...manualMeal, saturatedFat: e.target.value})}
                              className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                            />
                          </div>
                          <div>
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Vezels (g)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={manualMeal.fiber}
                              onChange={(e) => setManualMeal({...manualMeal, fiber: e.target.value})}
                              className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                            />
                          </div>
                          <div>
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Natrium (mg)</label>
                            <input
                              type="number"
                              value={manualMeal.sodium}
                              onChange={(e) => setManualMeal({...manualMeal, sodium: e.target.value})}
                              className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                            />
                          </div>
                        </div>
                        <button
                          onClick={addMealManually}
                          className="w-full px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm sm:text-base"
                        >
                          Maaltijd toevoegen
                        </button>
                      </div>
                    )}

                    {/* JSON Tab */}
                    {mealTab === 'json' && (
                      <div>
                        <div className="mb-4">
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">JSON Data</label>
                          <textarea
                            value={mealJson}
                            onChange={(e) => setMealJson(e.target.value)}
                            className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg font-mono text-xs sm:text-sm h-64"
                            placeholder='{"time": "12:00", "name": "Lunch", "calories": 500, ...}'
                          />
                        </div>
                        <button
                          onClick={importMealJson}
                          className="w-full px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm sm:text-base"
                        >
                          Importeer JSON
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Products Management Modal */}
            {showProducts && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full sm:max-w-4xl max-h-[95vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b p-3 sm:p-4 flex justify-between items-center">
                    <h3 className="text-lg sm:text-xl font-bold text-gray-800">Producten Database</h3>
                    <button onClick={() => setShowProducts(false)} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                  </div>
                  
                  <div className="p-3 sm:p-6">
                    <div className="flex flex-col sm:flex-row gap-2 mb-4">
                      <button
                        onClick={() => setShowAddProduct(true)}
                        className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm sm:text-base"
                      >
                        ‚ûï Nieuw Product
                      </button>
                      <button
                        onClick={() => setProductTab('json')}
                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 text-sm sm:text-base"
                      >
                        üì• Importeer JSON
                      </button>
                    </div>

                    {/* JSON Import Section */}
                    {productTab === 'json' && (
                      <div className="mb-4 p-3 sm:p-4 bg-blue-50 rounded-lg">
                        <h4 className="font-semibold mb-2 text-sm sm:text-base">Product JSON Importeren</h4>
                        <textarea
                          value={productJson}
                          onChange={(e) => setProductJson(e.target.value)}
                          className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg font-mono text-xs sm:text-sm h-32 mb-2"
                          placeholder='{"name": "Product", "calories": 100, ...} of [...array...]'
                        />
                        <div className="flex gap-2">
                          <button
                            onClick={importProductJson}
                            className="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                          >
                            Importeer
                          </button>
                          <button
                            onClick={() => {
                              setProductTab('manual');
                              setProductJson('');
                            }}
                            className="px-3 sm:px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm"
                          >
                            Annuleer
                          </button>
                        </div>
                      </div>
                    )}

                    <div className="flex flex-col sm:flex-row gap-2 mb-4">
                      <input
                        type="text"
                        value={productSearchDb}
                        onChange={(e) => setProductSearchDb(e.target.value)}
                        placeholder="Zoek product..."
                        className="flex-1 px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                      />
                      <select
                        value={productSort}
                        onChange={(e) => setProductSort(e.target.value)}
                        className="px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                      >
                        <option value="favorite">Favorieten eerst</option>
                        <option value="name-asc">Naam (A-Z)</option>
                        <option value="name-desc">Naam (Z-A)</option>
                        <option value="calories">Calorie√´n</option>
                        <option value="protein">Eiwit</option>
                        <option value="sodium">Natrium</option>
                      </select>
                    </div>

                    <div className="space-y-2">
                      {filteredProducts.map(product => (
                        <div key={product.id} className="flex items-center gap-2 p-2 sm:p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                          <button
                            onClick={() => toggleFavorite(product.id)}
                            className="text-lg sm:text-xl flex-shrink-0"
                          >
                            {product.favorite ? '‚≠ê' : '‚òÜ'}
                          </button>
                          <div className="flex-1 min-w-0">
                            <div className="font-semibold text-sm sm:text-base truncate">{product.name}</div>
                            <div className="text-xs text-gray-600 break-words">
                              {product.calories} kcal ‚Ä¢ {product.protein}g eiw ‚Ä¢ {product.saturatedFat}g v.vet ‚Ä¢ {product.fiber}g vez ‚Ä¢ {product.sodium}mg natr
                            </div>
                          </div>
                          <button
                            onClick={() => startEditProduct(product)}
                            className="px-2 sm:px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs sm:text-sm flex-shrink-0"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            onClick={() => deleteProduct(product.id)}
                            className="px-2 sm:px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs sm:text-sm flex-shrink-0"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Add/Edit Product Modal */}
            {showAddProduct && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full sm:max-w-md">
                  <div className="p-4 sm:p-6">
                    <h3 className="text-lg sm:text-xl font-bold text-gray-800 mb-4">
                      {editingProduct ? 'Product Bewerken' : 'Nieuw Product'}
                    </h3>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                        <input
                          type="text"
                          value={newProduct.name}
                          onChange={(e) => setNewProduct({...newProduct, name: e.target.value})}
                          className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                        />
                      </div>
                      <div className="grid grid-cols-2 gap-2 sm:gap-3">
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Calorie√´n (per 100g)</label>
                          <input
                            type="number"
                            value={newProduct.calories}
                            onChange={(e) => setNewProduct({...newProduct, calories: e.target.value})}
                            className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Eiwit (g)</label>
                          <input
                            type="number"
                            step="0.1"
                            value={newProduct.protein}
                            onChange={(e) => setNewProduct({...newProduct, protein: e.target.value})}
                            className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Vet (g)</label>
                          <input
                            type="number"
                            step="0.1"
                            value={newProduct.fat}
                            onChange={(e) => setNewProduct({...newProduct, fat: e.target.value})}
                            className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Verzadigd vet (g)</label>
                          <input
                            type="number"
                            step="0.1"
                            value={newProduct.saturatedFat}
                            onChange={(e) => setNewProduct({...newProduct, saturatedFat: e.target.value})}
                            className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Vezels (g)</label>
                          <input
                            type="number"
                            step="0.1"
                            value={newProduct.fiber}
                            onChange={(e) => setNewProduct({...newProduct, fiber: e.target.value})}
                            className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Natrium (mg)</label>
                          <input
                            type="number"
                            value={newProduct.sodium}
                            onChange={(e) => setNewProduct({...newProduct, sodium: e.target.value})}
                            className="w-full px-2 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                          />
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={newProduct.favorite}
                          onChange={(e) => setNewProduct({...newProduct, favorite: e.target.checked})}
                          className="w-4 h-4"
                        />
                        <label className="text-xs sm:text-sm text-gray-700">Markeer als favoriet ‚≠ê</label>
                      </div>
                      <div className="flex gap-2">
                        {editingProduct ? (
                          <>
                            <button
                              onClick={updateProduct}
                              className="flex-1 px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 text-sm sm:text-base"
                            >
                              Bijwerken
                            </button>
                            <button
                              onClick={cancelEditProduct}
                              className="flex-1 px-3 sm:px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm sm:text-base"
                            >
                              Annuleer
                            </button>
                          </>
                        ) : (
                          <>
                            <button
                              onClick={addProduct}
                              className="flex-1 px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm sm:text-base"
                            >
                              Toevoegen
                            </button>
                            <button
                              onClick={() => {
                                setShowAddProduct(false);
                                setNewProduct({ name: '', calories: '', protein: '', fat: '', saturatedFat: '', fiber: '', sodium: '', favorite: false });
                              }}
                              className="flex-1 px-3 sm:px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm sm:text-base"
                            >
                              Annuleer
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Report Modal */}
            {showReport && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full sm:max-w-4xl max-h-[95vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b p-3 sm:p-4 flex justify-between items-center">
                    <h3 className="text-lg sm:text-xl font-bold text-gray-800">Rapport</h3>
                    <button onClick={() => setShowReport(false)} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                  </div>
                  
                  <div className="p-3 sm:p-6">
                    <div className="flex flex-wrap gap-2 mb-3 sm:mb-4">
                      <button
                        onClick={() => setReportDays(7)}
                        className={`px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base ${reportDays === 7 ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                      >
                        7 dagen
                      </button>
                      <button
                        onClick={() => setReportDays(14)}
                        className={`px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base ${reportDays === 14 ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                      >
                        14 dagen
                      </button>
                      <button
                        onClick={() => setReportDays(28)}
                        className={`px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base ${reportDays === 28 ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                      >
                        28 dagen
                      </button>
                      <button
                        onClick={downloadReport}
                        className="px-3 sm:px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm sm:text-base"
                      >
                        üíæ TXT
                      </button>
                      <button
                        onClick={downloadPdfReport}
                        className="px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm sm:text-base"
                      >
                        üìÑ PDF
                      </button>
                    </div>

                    <div className="overflow-x-auto -mx-3 sm:mx-0">
                      <table className="w-full text-xs sm:text-sm">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="p-1 sm:p-2 text-left whitespace-nowrap">Datum</th>
                            <th className="p-1 sm:p-2 text-right whitespace-nowrap">Cal</th>
                            <th className="p-1 sm:p-2 text-right whitespace-nowrap">Eiw</th>
                            <th className="p-1 sm:p-2 text-right whitespace-nowrap">Vet</th>
                            <th className="p-1 sm:p-2 text-right whitespace-nowrap">V.vet</th>
                            <th className="p-1 sm:p-2 text-right whitespace-nowrap">Vezel</th>
                            <th className="p-1 sm:p-2 text-right whitespace-nowrap">Natr.</th>
                          </tr>
                        </thead>
                        <tbody>
                          {getReportData(reportDays).map(day => (
                            <tr key={day.date} className="border-b">
                              <td className="p-1 sm:p-2 whitespace-nowrap">{day.date}</td>
                              <td className="p-1 sm:p-2 text-right">{day.calories}</td>
                              <td className="p-1 sm:p-2 text-right">{day.protein.toFixed(1)}</td>
                              <td className="p-1 sm:p-2 text-right">{day.fat.toFixed(1)}</td>
                              <td className="p-1 sm:p-2 text-right">{day.saturatedFat.toFixed(1)}</td>
                              <td className="p-1 sm:p-2 text-right">{day.fiber.toFixed(1)}</td>
                              <td className="p-1 sm:p-2 text-right">{day.sodium}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<FoodJournal />, document.getElementById('root'));
  </script>

  <!-- Dashboard Script (Chart.js) - Deze blijft grotendeels hetzelfde -->
  <script>
    // Dashboard variables
    let dashboardData = [];
    let dashboardWeights = [];
    let dashboardSettings = null;
    let dashboardChart = null;
    let dashboardTimeRange = 7;
    let dashboardCustomDateFrom = null;
    let dashboardCustomDateTo = null;
    let dashboardDayType = 'rest';
    let dashboardVisibleMetrics = {
      calories: true,
      protein: true,
      saturatedFat: true,
      fiber: true,
      sodium: true,
      weight: true
    };

    const DASHBOARD_METRICS = {
      calories: { label: 'Calorie√´n', color: '#3b82f6', yAxisID: 'y', unit: 'kcal' },
      protein: { label: 'Eiwit', color: '#10b981', yAxisID: 'y1', unit: 'g' },
      saturatedFat: { label: 'Verzadigd vet', color: '#ef4444', yAxisID: 'y1', unit: 'g' },
      fiber: { label: 'Vezels', color: '#f59e0b', yAxisID: 'y1', unit: 'g' },
      sodium: { label: 'Natrium', color: '#8b5cf6', yAxisID: 'y', unit: 'mg' },
      weight: { label: 'Gewicht', color: '#ec4899', yAxisID: 'y2', unit: 'kg' }
    };

    async function loadDashboardData() {
      try {
        // Wait for db to be initialized
        if (!window.db) {
          console.log('Waiting for database initialization...');
          await new Promise(resolve => setTimeout(resolve, 100));
          return loadDashboardData();
        }
        const entries = await window.db.entries.toArray();
        dashboardData = entries;
        
        // Load weights
        const weights = await window.db.weights.toArray();
        dashboardWeights = weights;
        
        // Load settings
        dashboardSettings = await loadSettings();
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        dashboardData = [];
        dashboardWeights = [];
        dashboardSettings = DEFAULT_SETTINGS;
      }
    }

    function getDashboardDailyData() {
      const dateGroups = {};
      dashboardData.forEach(entry => {
        if (!dateGroups[entry.date]) {
          dateGroups[entry.date] = [];
        }
        dateGroups[entry.date].push(entry);
      });

      const dailyTotals = Object.keys(dateGroups)
        .map(date => {
          const dayEntries = dateGroups[date];
          const totals = dayEntries.reduce((acc, e) => ({
            calories: acc.calories + e.calories,
            protein: acc.protein + e.protein,
            saturatedFat: acc.saturatedFat + e.saturatedFat,
            fiber: acc.fiber + e.fiber,
            sodium: acc.sodium + e.sodium
          }), { calories: 0, protein: 0, saturatedFat: 0, fiber: 0, sodium: 0 });
          
          return {
            date,
            ...totals
          };
        })
        .sort((a, b) => a.date.localeCompare(b.date));

      // Apply date filtering
      let filteredData = dailyTotals;
      
      if (dashboardCustomDateFrom && dashboardCustomDateTo) {
        // Custom date range
        filteredData = dailyTotals.filter(d => 
          d.date >= dashboardCustomDateFrom && d.date <= dashboardCustomDateTo
        );
      } else if (dashboardTimeRange > 0) {
        // Preset days range
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - dashboardTimeRange);
        const cutoffString = cutoffDate.toISOString().split('T')[0];
        filteredData = dailyTotals.filter(d => d.date >= cutoffString);
      }
      // else: show all data
      
      return filteredData;
    }

    function calculateDashboardStats(dailyData) {
      if (dailyData.length === 0) return null;

      const avgCalories = Math.round(dailyData.reduce((sum, d) => sum + d.calories, 0) / dailyData.length);
      const avgProtein = (dailyData.reduce((sum, d) => sum + d.protein, 0) / dailyData.length).toFixed(1);
      const avgSaturatedFat = (dailyData.reduce((sum, d) => sum + d.saturatedFat, 0) / dailyData.length).toFixed(1);
      const avgFiber = (dailyData.reduce((sum, d) => sum + d.fiber, 0) / dailyData.length).toFixed(1);
      const avgSodium = Math.round(dailyData.reduce((sum, d) => sum + d.sodium, 0) / dailyData.length);

      const settings = dashboardSettings || DEFAULT_SETTINGS;
      const goal = dashboardDayType === 'sport' 
        ? { calories: settings.caloriesSport, protein: settings.proteinSport }
        : { calories: settings.caloriesRest, protein: settings.proteinRest };
      const deficit = goal.calories - avgCalories;
      // Positive = weight loss (calorie deficit), Negative = weight gain (calorie surplus)
      // Flip sign so positive number = weight gain, negative = weight loss (more intuitive)
      const projectedWeightChange = (-(deficit * 7) / 7700).toFixed(2);

      return {
        avgCalories,
        avgProtein,
        avgSaturatedFat,
        avgFiber,
        avgSodium,
        projectedWeightChange
      };
    }

    function updateDashboardChart() {
      const dailyData = getDashboardDailyData();
      
      if (dailyData.length === 0) {
        if (dashboardChart) {
          dashboardChart.destroy();
          dashboardChart = null;
        }
        return;
      }

      const labels = dailyData.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
      });

      const datasets = [];
      const annotations = {};
      const settings = dashboardSettings || DEFAULT_SETTINGS;
      const goal = dashboardDayType === 'sport' 
        ? { calories: settings.caloriesSport, protein: settings.proteinSport }
        : { calories: settings.caloriesRest, protein: settings.proteinRest };

      // Get weight data for the same date range
      const weightDataMap = {};
      if (dashboardWeights && dashboardWeights.length > 0) {
        // Filter weights based on current date range
        const filteredWeights = dashboardWeights.filter(w => {
          if (dashboardCustomDateFrom && dashboardCustomDateTo) {
            return w.date >= dashboardCustomDateFrom && w.date <= dashboardCustomDateTo;
          } else if (dashboardTimeRange > 0) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - dashboardTimeRange);
            const cutoffString = cutoffDate.toISOString().split('T')[0];
            return w.date >= cutoffString;
          }
          return true; // Show all if no range specified
        });
        
        filteredWeights.forEach(w => {
          weightDataMap[w.date] = w.weight;
        });
      }

      Object.entries(DASHBOARD_METRICS).forEach(([key, config]) => {
        if (dashboardVisibleMetrics[key]) {
          if (key === 'weight') {
            // Special handling for weight data
            const weightData = dailyData.map(d => weightDataMap[d.date] || null);
            datasets.push({
              label: config.label,
              data: weightData,
              borderColor: config.color,
              backgroundColor: config.color + '20',
              tension: 0.3,
              yAxisID: config.yAxisID,
              borderWidth: 3,
              pointRadius: 5,
              spanGaps: true // Connect points even with null values
            });
            
            // Add target weight line (use settings)
            const settings = dashboardSettings || DEFAULT_SETTINGS;
            annotations.weightGoal = {
              type: 'line',
              yMin: settings.targetWeight,
              yMax: settings.targetWeight,
              borderColor: '#ec4899',
              borderWidth: 2,
              borderDash: [5, 5],
              yScaleID: 'y2',
              label: {
                display: true,
                content: `Doel: ${settings.targetWeight} kg`,
                position: 'start'
              }
            };
          } else {
            datasets.push({
              label: config.label,
              data: dailyData.map(d => d[key]),
              borderColor: config.color,
              backgroundColor: config.color + '20',
              tension: 0.3,
              yAxisID: config.yAxisID,
              borderWidth: 2
            });

            if (key === 'calories' && dashboardVisibleMetrics.calories) {
              annotations.calorieGoal = {
                type: 'line',
                yMin: goal.calories,
                yMax: goal.calories,
                borderColor: '#3b82f6',
                borderWidth: 2,
                borderDash: [5, 5],
                label: {
                  display: true,
                  content: `Doel: ${goal.calories} kcal`,
                  position: 'end'
                }
              };
            }

            if (key === 'protein' && dashboardVisibleMetrics.protein) {
              annotations.proteinGoal = {
                type: 'line',
                yMin: goal.protein,
                yMax: goal.protein,
                borderColor: '#10b981',
                borderWidth: 2,
                borderDash: [5, 5],
                yScaleID: 'y1',
                label: {
                  display: true,
                  content: `Doel: ${goal.protein}g`,
                  position: 'start'
                }
              };
            }
          }
        }
      });

      if (dashboardChart) {
        dashboardChart.destroy();
      }

      const ctx = document.getElementById('trendsChart').getContext('2d');
      dashboardChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y === null) {
                    return label + 'Geen data';
                  }
                  const metric = Object.keys(DASHBOARD_METRICS).find(k => DASHBOARD_METRICS[k].label === context.dataset.label);
                  label += context.parsed.y.toFixed(1) + ' ' + DASHBOARD_METRICS[metric].unit;
                  return label;
                }
              }
            },
            annotation: {
              annotations: annotations
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Calorie√´n (kcal) / Natrium (mg)',
                color: '#3b82f6'
              },
              grid: {
                color: '#e5e7eb'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Gram (g)',
                color: '#6b7280'
              },
              grid: {
                drawOnChartArea: false
              }
            },
            y2: {
              type: 'linear',
              display: dashboardVisibleMetrics.weight,
              position: 'right',
              title: {
                display: true,
                text: 'Gewicht (kg)',
                color: '#ec4899'
              },
              grid: {
                drawOnChartArea: false
              },
              min: 70,
              max: 95
            },
            x: {
              grid: {
                color: '#e5e7eb'
              }
            }
          }
        }
      });
    }

    function updateDashboardStats() {
      const dailyData = getDashboardDailyData();
      const stats = calculateDashboardStats(dailyData);
      
      if (!stats) {
        document.getElementById('stats-cards').innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Geen data beschikbaar</div>';
        return;
      }

      const settings = dashboardSettings || DEFAULT_SETTINGS;
      const goal = dashboardDayType === 'sport' 
        ? { calories: settings.caloriesSport, protein: settings.proteinSport }
        : { calories: settings.caloriesRest, protein: settings.proteinRest };
      const statsHTML = `
        <div class="bg-white rounded-lg shadow p-4 stat-card">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-gray-600 text-sm font-medium">Gem. Calorie√´n</h3>
            <span class="text-xl">üî•</span>
          </div>
          <p class="text-2xl font-bold text-blue-600">${stats.avgCalories}</p>
          <p class="text-xs text-gray-500 mt-1">Max: ${goal.calories} kcal</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 stat-card">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-gray-600 text-sm font-medium">Gem. Eiwit</h3>
            <span class="text-xl">üí™</span>
          </div>
          <p class="text-2xl font-bold text-green-600">${stats.avgProtein}g</p>
          <p class="text-xs text-gray-500 mt-1">Doel: ${goal.protein}g</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 stat-card">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-gray-600 text-sm font-medium">Gem. Vezels</h3>
            <span class="text-xl">üåæ</span>
          </div>
          <p class="text-2xl font-bold text-amber-600">${stats.avgFiber}g</p>
          <p class="text-xs text-gray-500 mt-1">Min: 35g/dag</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 stat-card">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-gray-600 text-sm font-medium">Gem. Verzadigd vet</h3>
            <span class="text-xl">üßà</span>
          </div>
          <p class="text-2xl font-bold text-red-600">${stats.avgSaturatedFat}g</p>
          <p class="text-xs text-gray-500 mt-1">Max: 20g/dag</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 stat-card">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-gray-600 text-sm font-medium">Gem. Natrium</h3>
            <span class="text-xl">üßÇ</span>
          </div>
          <p class="text-2xl font-bold text-purple-600">${stats.avgSodium}mg</p>
          <p class="text-xs text-gray-500 mt-1">Max: 2300mg/dag</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 stat-card">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-gray-600 text-sm font-medium">Projectie/week</h3>
            <span class="text-xl">${stats.projectedWeightChange < 0 ? 'üìâ' : 'üìà'}</span>
          </div>
          <p class="text-2xl font-bold ${stats.projectedWeightChange < 0 ? 'text-green-600' : 'text-red-600'}">${stats.projectedWeightChange > 0 ? '+' : ''}${stats.projectedWeightChange}kg</p>
          <p class="text-xs text-gray-500 mt-1">${stats.projectedWeightChange < 0 ? 'Gewichtsverlies' : 'Gewichtstoename'}</p>
        </div>
      `;
      
      document.getElementById('stats-cards').innerHTML = statsHTML;
    }

    function updateDashboard() {
      loadDashboardData().then(() => {
        updateDashboardChart();
        updateDashboardStats();
      });
    }

    function setTimeRange(days) {
      dashboardTimeRange = days;
      dashboardCustomDateFrom = null;
      dashboardCustomDateTo = null;
      
      // Update dropdown to match
      document.getElementById('date-preset').value = days;
      
      // Disable custom date inputs
      document.getElementById('date-from').disabled = true;
      document.getElementById('date-to').disabled = true;
      
      document.querySelectorAll('.time-btn').forEach(btn => {
        if (btn.dataset.days == days) {
          btn.className = 'time-btn px-4 py-2 rounded-lg font-medium transition bg-blue-600 text-white';
        } else {
          btn.className = 'time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-700 hover:bg-gray-200';
        }
      });
      updateDashboardChart();
      updateDashboardStats();
    }

    function applyDatePreset() {
      const preset = document.getElementById('date-preset').value;
      const today = new Date();
      const dateFrom = document.getElementById('date-from');
      const dateTo = document.getElementById('date-to');
      
      if (preset === 'custom') {
        // Enable custom date inputs
        dateFrom.disabled = false;
        dateTo.disabled = false;
        dateTo.valueAsDate = today;
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        dateFrom.valueAsDate = weekAgo;
        return;
      }
      
      // Disable custom inputs for presets
      dateFrom.disabled = true;
      dateTo.disabled = true;
      
      let fromDate, toDate;
      
      if (preset === 'all') {
        dashboardTimeRange = 0; // Special: show all
        dashboardCustomDateFrom = null;
        dashboardCustomDateTo = null;
      } else if (preset === 'this-week') {
        const dayOfWeek = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        fromDate = monday.toISOString().split('T')[0];
        toDate = today.toISOString().split('T')[0];
        dashboardCustomDateFrom = fromDate;
        dashboardCustomDateTo = toDate;
        dashboardTimeRange = -1; // Indicate custom range
      } else if (preset === 'last-week') {
        const dayOfWeek = today.getDay();
        const lastMonday = new Date(today);
        lastMonday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) - 7);
        const lastSunday = new Date(lastMonday);
        lastSunday.setDate(lastMonday.getDate() + 6);
        fromDate = lastMonday.toISOString().split('T')[0];
        toDate = lastSunday.toISOString().split('T')[0];
        dashboardCustomDateFrom = fromDate;
        dashboardCustomDateTo = toDate;
        dashboardTimeRange = -1;
      } else if (preset === 'this-month') {
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        fromDate = firstDay.toISOString().split('T')[0];
        toDate = today.toISOString().split('T')[0];
        dashboardCustomDateFrom = fromDate;
        dashboardCustomDateTo = toDate;
        dashboardTimeRange = -1;
      } else if (preset === 'last-month') {
        const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
        fromDate = firstDay.toISOString().split('T')[0];
        toDate = lastDay.toISOString().split('T')[0];
        dashboardCustomDateFrom = fromDate;
        dashboardCustomDateTo = toDate;
        dashboardTimeRange = -1;
      } else {
        // Numeric preset (7, 14, 30, 90 days)
        dashboardTimeRange = parseInt(preset);
        dashboardCustomDateFrom = null;
        dashboardCustomDateTo = null;
        setTimeRange(dashboardTimeRange);
        return;
      }
      
      // Update display if custom dates were set
      if (dashboardCustomDateFrom) {
        dateFrom.value = dashboardCustomDateFrom;
        dateTo.value = dashboardCustomDateTo;
      }
      
      updateDashboardChart();
      updateDashboardStats();
    }

    function applyCustomDateRange() {
      const fromDate = document.getElementById('date-from').value;
      const toDate = document.getElementById('date-to').value;
      
      if (!fromDate || !toDate) {
        alert('Selecteer beide datums');
        return;
      }
      
      if (fromDate > toDate) {
        alert('Van-datum moet voor Tot-datum liggen');
        return;
      }
      
      dashboardCustomDateFrom = fromDate;
      dashboardCustomDateTo = toDate;
      dashboardTimeRange = -1; // Indicate custom range
      
      document.getElementById('date-preset').value = 'custom';
      
      updateDashboardChart();
      updateDashboardStats();
    }

    function setDashboardDayType(type) {
      dashboardDayType = type;
      if (type === 'rest') {
        document.getElementById('dash-btn-rest').className = 'px-4 py-2 rounded-lg font-medium transition bg-blue-600 text-white';
        document.getElementById('dash-btn-sport').className = 'px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300';
      } else {
        document.getElementById('dash-btn-sport').className = 'px-4 py-2 rounded-lg font-medium transition bg-green-600 text-white';
        document.getElementById('dash-btn-rest').className = 'px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300';
      }
      updateDashboardChart();
      updateDashboardStats();
    }

    function toggleMetric(metric) {
      dashboardVisibleMetrics[metric] = !dashboardVisibleMetrics[metric];
      const btn = document.querySelector(`button[data-metric="${metric}"]`);
      if (dashboardVisibleMetrics[metric]) {
        btn.className = 'metric-btn px-3 py-2 rounded-lg text-sm font-medium transition text-white';
        btn.style.backgroundColor = DASHBOARD_METRICS[metric].color;
      } else {
        btn.className = 'metric-btn px-3 py-2 rounded-lg text-sm font-medium transition bg-gray-100 text-gray-400 hover:bg-gray-200';
        btn.style.backgroundColor = '';
      }
      updateDashboardChart();
    }

    function refreshDashboard() {
      updateDashboard();
    }

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(updateDashboard, 500);
    });
  </script>

  <!-- PDF Generation Script -->
  <script>
    // Helper function: Add line chart for week
    async function addWeekLineChart(doc, weekDates, dateGroups, yPos) {
      // Create temporary canvas
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 300;
      const ctx = canvas.getContext('2d');

      // Prepare data
      const labels = [];
      const caloriesData = [];
      const proteinData = [];
      const fiberData = [];
      const saturatedFatData = [];
      const sodiumData = [];

      weekDates.forEach(date => {
        const dayEntries = dateGroups[date];
        if (dayEntries) {
          const dayTotal = dayEntries.reduce((acc, e) => ({
            calories: acc.calories + e.calories,
            protein: acc.protein + e.protein,
            saturatedFat: acc.saturatedFat + e.saturatedFat,
            fiber: acc.fiber + e.fiber,
            sodium: acc.sodium + e.sodium
          }), { calories: 0, protein: 0, saturatedFat: 0, fiber: 0, sodium: 0 });
          
          labels.push(date.substr(8, 2) + '-' + date.substr(5, 2));
          caloriesData.push(dayTotal.calories);
          proteinData.push(dayTotal.protein);
          fiberData.push(dayTotal.fiber);
          saturatedFatData.push(dayTotal.saturatedFat);
          sodiumData.push(dayTotal.sodium);
        }
      });

      // Create chart
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Calorie√´n',
              data: caloriesData,
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              yAxisID: 'y',
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: 'Eiwit (g)',
              data: proteinData,
              borderColor: 'rgb(16, 185, 129)',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              yAxisID: 'y1',
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: 'Vezels (g)',
              data: fiberData,
              borderColor: 'rgb(245, 158, 11)',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              yAxisID: 'y1',
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: 'Verz. vet (g)',
              data: saturatedFatData,
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              yAxisID: 'y1',
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: 'Natrium (mg)',
              data: sodiumData,
              borderColor: 'rgb(139, 92, 246)',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              yAxisID: 'y',
              borderWidth: 2,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: false,
          animation: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { size: 11 },
                boxWidth: 15
              }
            },
            title: {
              display: true,
              text: 'Dagelijkse waarden',
              font: { size: 12 }
            }
          },
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'Calorie√´n / Natrium',
                font: { size: 11 }
              },
              ticks: { font: { size: 10 } }
            },
            y1: {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: 'Gram (g)',
                font: { size: 11 }
              },
              grid: {
                drawOnChartArea: false
              },
              ticks: { font: { size: 10 } }
            },
            x: {
              ticks: { font: { size: 10 } }
            }
          }
        }
      });

      // Wait for chart to render
      await new Promise(resolve => setTimeout(resolve, 100));

      // Convert canvas to image and add to PDF
      const imgData = canvas.toDataURL('image/png');
      doc.addImage(imgData, 'PNG', 15, yPos, 180, 45);

      // Cleanup
      chart.destroy();
      canvas.remove();
    }

    // Helper function: Calculate gradient color for macro
    function getGradientColor(value, type) {
      let percentage, r, g, b;
      
      switch(type) {
        case 'calories':
          // Calorie√´n: groen (onder), geel (bij), rood (boven)
          const calGoal = 1900;
          percentage = Math.min(value / calGoal, 1.5);
          if (percentage <= 0.95) {
            r = 34; g = 197; b = 94;
          } else if (percentage <= 1.05) {
            const t = (percentage - 0.95) / 0.1;
            r = Math.round(34 + (234 - 34) * t);
            g = Math.round(197 + (179 - 197) * t);
            b = Math.round(94 + (8 - 94) * t);
          } else {
            const t = Math.min((percentage - 1.05) / 0.2, 1);
            r = Math.round(234 + (239 - 234) * t);
            g = Math.round(179 - 179 * t);
            b = 8;
          }
          break;
          
        case 'protein':
          // Eiwit: rood (0) ‚Üí geel (35g) ‚Üí lichtgroen (71g) ‚Üí donkergroen (110g+)
          if (value <= 35) {
            const t = value / 35;
            r = 239;
            g = Math.round(68 + (179 - 68) * t);
            b = Math.round(68 + (8 - 68) * t);
          } else if (value <= 71) {
            const t = (value - 35) / 36;
            r = Math.round(234 - (234 - 134) * t);
            g = Math.round(179 + (239 - 179) * t);
            b = Math.round(8 + (172 - 8) * t);
          } else {
            const t = Math.min((value - 71) / 49, 1);
            r = Math.round(134 - (134 - 34) * t);
            g = Math.round(239 - (239 - 197) * t);
            b = Math.round(172 - (172 - 94) * t);
          }
          break;
          
        case 'fiber':
          // Vezels: rood (0) ‚Üí geel (17.5g) ‚Üí groen (35g+)
          if (value <= 17.5) {
            const t = value / 17.5;
            r = Math.round(239 + (234 - 239) * t);
            g = Math.round(68 + (179 - 68) * t);
            b = Math.round(68 + (8 - 68) * t);
          } else {
            const t = Math.min((value - 17.5) / 17.5, 1);
            r = Math.round(234 - (234 - 34) * t);
            g = Math.round(179 + (197 - 179) * t);
            b = Math.round(8 + (94 - 8) * t);
          }
          break;
          
        case 'saturatedFat':
          // Verzadigd vet: groen (0-10g) ‚Üí geel (10-20g) ‚Üí rood (20g+)
          if (value <= 10) {
            r = 34; g = 197; b = 94;
          } else if (value <= 20) {
            const t = (value - 10) / 10;
            r = Math.round(34 + (234 - 34) * t);
            g = Math.round(197 + (179 - 197) * t);
            b = Math.round(94 + (8 - 94) * t);
          } else {
            const t = Math.min((value - 20) / 10, 1);
            r = Math.round(234 + (239 - 234) * t);
            g = Math.round(179 - 179 * t);
            b = 8;
          }
          break;
          
        case 'sodium':
          // Natrium: groen (0-1150mg) ‚Üí geel (1150-2300mg) ‚Üí rood (2300mg+)
          if (value <= 1150) {
            r = 34; g = 197; b = 94;
          } else if (value <= 2300) {
            const t = (value - 1150) / 1150;
            r = Math.round(34 + (234 - 34) * t);
            g = Math.round(197 + (179 - 197) * t);
            b = Math.round(94 + (8 - 94) * t);
          } else {
            const t = Math.min((value - 2300) / 700, 1);
            r = Math.round(234 + (239 - 234) * t);
            g = Math.round(179 - 179 * t);
            b = 8;
          }
          break;
          
        default:
          r = 200; g = 200; b = 200;
      }
      
      return { r, g, b };
    }

    // Generate PDF Report
    async function generatePdfReport(entries, days) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Helper function to format date from yyyy-MM-dd to dd-MM-yyyy
      function formatDateForPDF(dateStr) {
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
      }
      
      // Group entries by date
      const dateGroups = {};
      entries.forEach(entry => {
        if (!dateGroups[entry.date]) {
          dateGroups[entry.date] = [];
        }
        dateGroups[entry.date].push(entry);
      });

      // Get relevant dates
      const relevantDates = Object.keys(dateGroups)
        .sort()
        .reverse()
        .slice(0, days);

      if (relevantDates.length === 0) {
        alert('Geen data beschikbaar voor rapport');
        return;
      }

      relevantDates.reverse();

      // Group dates into weeks
      const weeks = [];
      let currentWeek = [];
      relevantDates.forEach((date, index) => {
        currentWeek.push(date);
        if (currentWeek.length === 7 || index === relevantDates.length - 1) {
          weeks.push([...currentWeek]);
          currentWeek = [];
        }
      });

      let yPos = 20;

      // Title
      doc.setFontSize(20);
      doc.setTextColor(31, 41, 55);
      doc.text('Voedseljournaal Rapport', 15, yPos);
      yPos += 10;
      
      doc.setFontSize(10);
      doc.setTextColor(107, 114, 128);
      doc.text(`Periode: ${formatDateForPDF(relevantDates[0])} tot ${formatDateForPDF(relevantDates[relevantDates.length - 1])}`, 15, yPos);
      doc.text(`Gegenereerd: ${new Date().toLocaleDateString('nl-NL')}`, 15, yPos + 5);
      yPos += 15;

      // Process each week
      for (let weekIndex = 0; weekIndex < weeks.length; weekIndex++) {
        const weekDates = weeks[weekIndex];
        
        // Check if we need a new page for week header + cards + chart
        if (yPos > 200) {
          doc.addPage();
          yPos = 20;
        }

        // Week Header
        doc.setFontSize(14);
        doc.setTextColor(31, 41, 55);
        doc.text(`Week ${weekIndex + 1}: ${formatDateForPDF(weekDates[0])} tot ${formatDateForPDF(weekDates[weekDates.length - 1])}`, 15, yPos);
        yPos += 8;

        // Calculate week averages
        const weekTotals = { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 };
        let dayCount = 0;
        
        weekDates.forEach(date => {
          if (dateGroups[date]) {
            dayCount++;
            const dayEntries = dateGroups[date];
            const dayTotal = dayEntries.reduce((acc, e) => ({
              calories: acc.calories + e.calories,
              protein: acc.protein + e.protein,
              fat: acc.fat + e.fat,
              saturatedFat: acc.saturatedFat + e.saturatedFat,
              fiber: acc.fiber + e.fiber,
              sodium: acc.sodium + e.sodium
            }), { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 });
            
            weekTotals.calories += dayTotal.calories;
            weekTotals.protein += dayTotal.protein;
            weekTotals.fat += dayTotal.fat;
            weekTotals.saturatedFat += dayTotal.saturatedFat;
            weekTotals.fiber += dayTotal.fiber;
            weekTotals.sodium += dayTotal.sodium;
          }
        });

        const weekAvg = {
          calories: Math.round(weekTotals.calories / dayCount),
          protein: parseFloat((weekTotals.protein / dayCount).toFixed(1)),
          fat: parseFloat((weekTotals.fat / dayCount).toFixed(1)),
          saturatedFat: parseFloat((weekTotals.saturatedFat / dayCount).toFixed(1)),
          fiber: parseFloat((weekTotals.fiber / dayCount).toFixed(1)),
          sodium: Math.round(weekTotals.sodium / dayCount)
        };

        // Gradient Cards
        doc.setFontSize(11);
        doc.setTextColor(55, 65, 81);
        doc.text('Weekgemiddelden:', 15, yPos);
        yPos += 7;

        const cardWidth = 35;
        const cardHeight = 16;
        const cardSpacing = 3;
        let cardX = 15;

        const metrics = [
          { key: 'calories', label: 'Calorie√´n', value: weekAvg.calories, unit: 'kcal', target: '<1900' },
          { key: 'protein', label: 'Eiwit', value: weekAvg.protein, unit: 'g', target: '110-120' },
          { key: 'fiber', label: 'Vezels', value: weekAvg.fiber, unit: 'g', target: '>=35' },
          { key: 'saturatedFat', label: 'Verz. vet', value: weekAvg.saturatedFat, unit: 'g', target: '<20' },
          { key: 'sodium', label: 'Natrium', value: weekAvg.sodium, unit: 'mg', target: '<2300' }
        ];

        metrics.forEach((metric, index) => {
          const color = getGradientColor(metric.value, metric.key);
          
          doc.setFillColor(color.r, color.g, color.b);
          doc.roundedRect(cardX, yPos, cardWidth, cardHeight, 2, 2, 'F');
          
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(7);
          doc.text(metric.label, cardX + 2, yPos + 4);
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text(`${metric.value}${metric.unit}`, cardX + 2, yPos + 10);
          doc.setFont(undefined, 'normal');
          
          doc.setFontSize(6);
          doc.text(metric.target, cardX + 2, yPos + 14);

          cardX += cardWidth + cardSpacing;
        });

        yPos += cardHeight + 8;

        // Add line chart for the week
        await addWeekLineChart(doc, weekDates, dateGroups, yPos);
        yPos += 55; // Chart height + spacing

        // Daily details
        weekDates.forEach(date => {
          const dayEntries = dateGroups[date];
          if (!dayEntries) return;

          // Check page space - need more room now because of chart above
          if (yPos > 220) {
            doc.addPage();
            yPos = 20;
          }

          doc.setFontSize(11);
          doc.setTextColor(31, 41, 55);
          doc.setFont(undefined, 'bold');
          doc.text(formatDateForPDF(date), 15, yPos);
          doc.setFont(undefined, 'normal');
          yPos += 6;

          const mealRows = dayEntries
            .sort((a, b) => a.time.localeCompare(b.time))
            .map(entry => [
              entry.time,
              entry.name,
              entry.calories,
              entry.protein.toFixed(1),
              entry.saturatedFat.toFixed(1),
              entry.fiber.toFixed(1),
              entry.sodium
            ]);

          const dayTotal = dayEntries.reduce((acc, e) => ({
            calories: acc.calories + e.calories,
            protein: acc.protein + e.protein,
            saturatedFat: acc.saturatedFat + e.saturatedFat,
            fiber: acc.fiber + e.fiber,
            sodium: acc.sodium + e.sodium
          }), { calories: 0, protein: 0, saturatedFat: 0, fiber: 0, sodium: 0 });

          mealRows.push([
            '',
            'TOTAAL',
            dayTotal.calories,
            dayTotal.protein.toFixed(1),
            dayTotal.saturatedFat.toFixed(1),
            dayTotal.fiber.toFixed(1),
            dayTotal.sodium
          ]);

          doc.autoTable({
            startY: yPos,
            head: [['Tijd', 'Maaltijd', 'Kcal', 'Eiw', 'V.vet', 'Vez', 'Natr']],
            body: mealRows,
            theme: 'striped',
            headStyles: { fillColor: [59, 130, 246], fontSize: 8 },
            bodyStyles: { fontSize: 8 },
            columnStyles: {
              0: { cellWidth: 15 },
              1: { cellWidth: 85 },
              2: { cellWidth: 20, halign: 'right' },
              3: { cellWidth: 15, halign: 'right' },
              4: { cellWidth: 15, halign: 'right' },
              5: { cellWidth: 15, halign: 'right' },
              6: { cellWidth: 15, halign: 'right' }
            },
            margin: { left: 15, right: 15 },
            didDrawPage: function(data) {
              yPos = data.cursor.y;
            }
          });

          yPos += 5;
        });

        yPos += 5;
      }

      // Overall summary
      if (yPos > 180) {
        doc.addPage();
        yPos = 20;
      }

      const overallTotals = { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 };
      let totalDays = 0;
      
      relevantDates.forEach(date => {
        if (dateGroups[date]) {
          totalDays++;
          const dayEntries = dateGroups[date];
          const dayTotal = dayEntries.reduce((acc, e) => ({
            calories: acc.calories + e.calories,
            protein: acc.protein + e.protein,
            fat: acc.fat + e.fat,
            saturatedFat: acc.saturatedFat + e.saturatedFat,
            fiber: acc.fiber + e.fiber,
            sodium: acc.sodium + e.sodium
          }), { calories: 0, protein: 0, fat: 0, saturatedFat: 0, fiber: 0, sodium: 0 });
          
          overallTotals.calories += dayTotal.calories;
          overallTotals.protein += dayTotal.protein;
          overallTotals.fat += dayTotal.fat;
          overallTotals.saturatedFat += dayTotal.saturatedFat;
          overallTotals.fiber += dayTotal.fiber;
          overallTotals.sodium += dayTotal.sodium;
        }
      });

      const overallAvg = {
        calories: Math.round(overallTotals.calories / totalDays),
        protein: parseFloat((overallTotals.protein / totalDays).toFixed(1)),
        fat: parseFloat((overallTotals.fat / totalDays).toFixed(1)),
        saturatedFat: parseFloat((overallTotals.saturatedFat / totalDays).toFixed(1)),
        fiber: parseFloat((overallTotals.fiber / totalDays).toFixed(1)),
        sodium: Math.round(overallTotals.sodium / totalDays)
      };

      doc.setFontSize(14);
      doc.setTextColor(31, 41, 55);
      doc.setFont(undefined, 'bold');
      doc.text('Totaaloverzicht', 15, yPos);
      doc.setFont(undefined, 'normal');
      yPos += 8;

      doc.setFontSize(10);
      doc.text(`Gemiddelden over ${totalDays} dagen:`, 15, yPos);
      yPos += 7;

      doc.autoTable({
        startY: yPos,
        head: [['Metric', 'Gemiddelde', 'Doel/Limiet']],
        body: [
          ['Calorieen', `${overallAvg.calories} kcal`, '< 1900 kcal'],
          ['Eiwit', `${overallAvg.protein}g`, '110-120g'],
          ['Totaal Vet', `${overallAvg.fat}g`, '-'],
          ['Verzadigd Vet', `${overallAvg.saturatedFat}g`, '< 20g'],
          ['Vezels', `${overallAvg.fiber}g`, '>= 35g'],
          ['Natrium', `${overallAvg.sodium}mg`, '< 2300mg']
        ],
        theme: 'grid',
        headStyles: { fillColor: [31, 41, 55] },
        columnStyles: {
          0: { cellWidth: 50 },
          1: { cellWidth: 50, halign: 'right' },
          2: { cellWidth: 50, halign: 'right' }
        }
      });

      // Page numbers
      const pageHeight = doc.internal.pageSize.height;
      for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(156, 163, 175);
        doc.text(`Pagina ${i} van ${doc.internal.getNumberOfPages()}`, 105, pageHeight - 10, { align: 'center' });
      }

      // Save PDF
      const fileName = `voedseljournaal_rapport_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
    }

    window.generatePdfReport = generatePdfReport;
  </script>

  <!-- Analysis Section Script -->
  <script>
    async function updateAnalysis() {
      await loadDashboardData(); // Ensure data is loaded
      updateWeekComparison();
      updateHeatmap();
      updateWeekdayTrends();
    }

    // Get analysis data - independent from dashboard filters
    function getAnalysisDailyData(daysBack = 60) {
      const dateGroups = {};
      dashboardData.forEach(entry => {
        if (!dateGroups[entry.date]) {
          dateGroups[entry.date] = [];
        }
        dateGroups[entry.date].push(entry);
      });

      const dailyTotals = Object.keys(dateGroups)
        .map(date => {
          const dayEntries = dateGroups[date];
          const totals = dayEntries.reduce((acc, e) => ({
            calories: acc.calories + e.calories,
            protein: acc.protein + e.protein,
            saturatedFat: acc.saturatedFat + e.saturatedFat,
            fiber: acc.fiber + e.fiber,
            sodium: acc.sodium + e.sodium
          }), { calories: 0, protein: 0, saturatedFat: 0, fiber: 0, sodium: 0 });
          
          return {
            date,
            ...totals
          };
        })
        .sort((a, b) => a.date.localeCompare(b.date));

      // Filter last N days or all data
      if (daysBack === 0) {
        return dailyTotals; // All data
      }
      
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - daysBack);
      const cutoffString = cutoffDate.toISOString().split('T')[0];
      
      return dailyTotals.filter(d => d.date >= cutoffString);
    }

    function updateWeekComparison() {
      const dailyData = getAnalysisDailyData(60); // Last 60 days for analysis
      
      if (dailyData.length === 0) {
        document.getElementById('week-comparison-table').innerHTML = '<p class="text-gray-500 text-center py-4">Geen data beschikbaar</p>';
        return;
      }

      // Group data by week
      const weeks = {};
      dailyData.forEach(day => {
        const date = new Date(day.date);
        // Get Monday of the week
        const dayOfWeek = date.getDay();
        const monday = new Date(date);
        monday.setDate(date.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        const weekKey = monday.toISOString().split('T')[0];
        
        if (!weeks[weekKey]) {
          weeks[weekKey] = [];
        }
        weeks[weekKey].push(day);
      });

      // Calculate averages per week
      const weekStats = Object.entries(weeks)
        .map(([weekStart, days]) => {
          const monday = new Date(weekStart);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          
          const avg = {
            weekStart: weekStart,
            weekEnd: sunday.toISOString().split('T')[0],
            days: days.length,
            calories: Math.round(days.reduce((sum, d) => sum + d.calories, 0) / days.length),
            protein: (days.reduce((sum, d) => sum + d.protein, 0) / days.length).toFixed(1),
            saturatedFat: (days.reduce((sum, d) => sum + d.saturatedFat, 0) / days.length).toFixed(1),
            fiber: (days.reduce((sum, d) => sum + d.fiber, 0) / days.length).toFixed(1),
            sodium: Math.round(days.reduce((sum, d) => sum + d.sodium, 0) / days.length),
            daysUnderCalorieGoal: days.filter(d => d.calories < 1900).length
          };
          return avg;
        })
        .sort((a, b) => b.weekStart.localeCompare(a.weekStart))
        .slice(0, 8); // Last 8 weeks

      // Build table HTML
      let html = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dagen</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√ò Kcal</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√ò Eiwit</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√ò V.vet</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√ò Vezels</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√ò Natrium</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dagen <1900</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;

      weekStats.forEach((week, index) => {
        const prevWeek = weekStats[index + 1];
        const formatDate = (d) => {
          const date = new Date(d);
          return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
        };
        
        // Calculate trends
        const getTrend = (current, previous, lower = false) => {
          if (!previous) return '';
          const diff = current - previous;
          if (Math.abs(diff) < (lower ? 50 : 2)) return '‚Üí';
          if (lower) {
            return diff < 0 ? '‚ÜòÔ∏è' : '‚ÜóÔ∏è'; // Lower is better
          } else {
            return diff > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
          }
        };
        
        // Color logic with gradient thresholds
        const getProteinColor = (val) => {
          const v = parseFloat(val);
          if (v < 36) return 'text-red-600 font-semibold';
          if (v < 72) return 'text-yellow-600 font-semibold';
          return 'text-green-600 font-semibold';
        };
        
        const getFiberColor = (val) => {
          const v = parseFloat(val);
          if (v < 17.5) return 'text-red-600 font-semibold';
          if (v < 35) return 'text-yellow-600 font-semibold';
          return 'text-green-600 font-semibold';
        };

        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(week.weekStart)} - ${formatDate(week.weekEnd)}</td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${week.days}/7</td>
            <td class="px-3 py-4 whitespace-nowrap text-sm ${week.calories < 1900 ? 'text-green-600 font-semibold' : 'text-gray-900'}">
              ${week.calories} ${getTrend(week.calories, prevWeek?.calories, true)}
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm ${getProteinColor(week.protein)}">
              ${week.protein}g ${getTrend(week.protein, prevWeek?.protein)}
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm ${week.saturatedFat < 20 ? 'text-green-600 font-semibold' : 'text-gray-900'}">
              ${week.saturatedFat}g ${getTrend(week.saturatedFat, prevWeek?.saturatedFat, true)}
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm ${getFiberColor(week.fiber)}">
              ${week.fiber}g ${getTrend(week.fiber, prevWeek?.fiber)}
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm ${week.sodium < 2300 ? 'text-green-600 font-semibold' : 'text-gray-900'}">
              ${week.sodium}mg ${getTrend(week.sodium, prevWeek?.sodium, true)}
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${week.daysUnderCalorieGoal}/${week.days}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      document.getElementById('week-comparison-table').innerHTML = html;
    }

    function updateHeatmap() {
      const metric = document.getElementById('heatmap-metric').value;
      const dailyData = getAnalysisDailyData(60); // Last 60 days for analysis
      
      if (dailyData.length === 0) {
        document.getElementById('heatmap-container').innerHTML = '<p class="text-gray-500 text-center py-4">Geen data beschikbaar</p>';
        return;
      }

      // Get last 8 weeks of data
      const today = new Date();
      const eightWeeksAgo = new Date(today);
      eightWeeksAgo.setDate(today.getDate() - 56);
      
      const filteredData = dailyData.filter(d => new Date(d.date) >= eightWeeksAgo);
      
      // Create date map
      const dataMap = {};
      filteredData.forEach(d => {
        dataMap[d.date] = d;
      });

      // Generate calendar grid (8 weeks)
      const weeks = [];
      for (let i = 7; i >= 0; i--) {
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - (i * 7) - today.getDay() + 1); // Monday
        const week = [];
        
        for (let j = 0; j < 7; j++) {
          const date = new Date(weekStart);
          date.setDate(weekStart.getDate() + j);
          const dateStr = date.toISOString().split('T')[0];
          week.push({
            date: dateStr,
            dayName: ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'][date.getDay()],
            data: dataMap[dateStr]
          });
        }
        weeks.push(week);
      }

      // Calculate color for each day based on gradient thresholds
      const getColor = (day) => {
        if (!day.data) return 'bg-gray-200';
        
        let value;
        
        if (metric === 'overall') {
          // Calculate overall score (percentage of targets met)
          let score = 0;
          let total = 5;
          if (day.data.calories < 1900) score++;
          // Protein: gradient logic (minimum is ~72g for 86.8kg)
          if (day.data.protein >= 36) score++; // At least 50% of minimum
          if (day.data.saturatedFat < 20) score++;
          // Fiber: gradient logic
          if (day.data.fiber >= 17.5) score++; // At least 50% of target
          if (day.data.sodium < 2300) score++;
          
          const percentage = (score / total) * 100;
          if (percentage >= 80) return 'bg-green-500';
          if (percentage >= 60) return 'bg-yellow-400';
          return 'bg-red-500';
        }
        
        // Single metric
        value = day.data[metric];
        
        switch(metric) {
          case 'calories':
            if (value < 1900) return 'bg-green-500';
            if (value < 2100) return 'bg-yellow-400';
            return 'bg-red-500';
          case 'protein':
            // Gradient logic: 0-36g red, 36-72g yellow, >72g green
            if (value < 36) return 'bg-red-500';
            if (value < 72) return 'bg-yellow-400';
            return 'bg-green-500';
          case 'saturatedFat':
            if (value < 20) return 'bg-green-500';
            if (value < 25) return 'bg-yellow-400';
            return 'bg-red-500';
          case 'fiber':
            // Gradient logic: 0-17.5g red, 17.5-35g yellow, >=35g green
            if (value < 17.5) return 'bg-red-500';
            if (value < 35) return 'bg-yellow-400';
            return 'bg-green-500';
          case 'sodium':
            if (value < 2300) return 'bg-green-500';
            if (value < 2800) return 'bg-yellow-400';
            return 'bg-red-500';
          default:
            return 'bg-gray-200';
        }
      };

      // Calculate week number from date
      function getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
      }

      // Build heatmap HTML
      let html = '<div class="w-fit">';
      
      // Day headers
      html += '<div class="flex gap-1 mb-2">';
      html += '<div class="w-8"></div>'; // Space for week numbers (smaller)
      ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'].forEach(day => {
        html += `<div class="w-10 text-center text-xs font-medium text-gray-600">${day}</div>`;
      });
      html += '</div>';

      // Weeks
      weeks.forEach((week) => {
        // Get week number from first day (Monday) of the week
        const weekNum = getWeekNumber(week[0].date);
        
        html += '<div class="flex gap-1 mb-1">';
        html += `<div class="w-8 text-xs text-gray-500 flex items-center">W${weekNum}</div>`;
        
        week.forEach(day => {
          const color = getColor(day);
          const tooltip = day.data ? 
            `${day.date}: ${metric === 'overall' ? 'Score' : DASHBOARD_METRICS[metric]?.label || metric}` : 
            'Geen data';
          
          html += `
            <div class="w-10 h-10 rounded ${color} flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-purple-400 transition" 
                 title="${tooltip}">
              <span class="text-xs font-medium text-white">${new Date(day.date).getDate()}</span>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      html += '</div>';

      document.getElementById('heatmap-container').innerHTML = html;
    }

    function updateWeekdayTrends() {
      const dailyData = getAnalysisDailyData(60); // Last 60 days for analysis
      
      if (dailyData.length === 0) {
        document.getElementById('weekday-trends').innerHTML = '<p class="text-gray-500 text-center py-4 col-span-full">Geen data beschikbaar</p>';
        return;
      }

      // Group by weekday
      const weekdays = {
        1: { name: 'Maandag', days: [], emoji: 'üìÖ' },
        2: { name: 'Dinsdag', days: [], emoji: 'üìÖ' },
        3: { name: 'Woensdag', days: [], emoji: 'üç∫' },
        4: { name: 'Donderdag', days: [], emoji: 'üçï' },
        5: { name: 'Vrijdag', days: [], emoji: 'üìÖ' },
        6: { name: 'Zaterdag', days: [], emoji: 'üèñÔ∏è' },
        0: { name: 'Zondag', days: [], emoji: 'üò¥' }
      };

      dailyData.forEach(day => {
        const date = new Date(day.date);
        const dayOfWeek = date.getDay();
        weekdays[dayOfWeek].days.push(day);
      });

      // Calculate averages and patterns
      let html = '';
      [1, 2, 3, 4, 5, 6, 0].forEach(dayNum => {
        const weekday = weekdays[dayNum];
        if (weekday.days.length === 0) return;

        const avg = {
          calories: Math.round(weekday.days.reduce((sum, d) => sum + d.calories, 0) / weekday.days.length),
          protein: (weekday.days.reduce((sum, d) => sum + d.protein, 0) / weekday.days.length).toFixed(1),
          saturatedFat: (weekday.days.reduce((sum, d) => sum + d.saturatedFat, 0) / weekday.days.length).toFixed(1),
          fiber: (weekday.days.reduce((sum, d) => sum + d.fiber, 0) / weekday.days.length).toFixed(1),
          sodium: Math.round(weekday.days.reduce((sum, d) => sum + d.sodium, 0) / weekday.days.length)
        };

        // Detect patterns
        const percentAboveCalories = (weekday.days.filter(d => d.calories > 1900).length / weekday.days.length) * 100;
        const percentAboveSodium = (weekday.days.filter(d => d.sodium > 2300).length / weekday.days.length) * 100;

        let badge = '';
        if (percentAboveCalories > 75) {
          badge = '<span class="inline-block px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">‚ö†Ô∏è Vaak boven calorie-target</span>';
        } else if (avg.calories < 1900 && parseFloat(avg.protein) >= 72) {
          // Excellente dag: binnen calorie√´n en goed eiwit (boven minimum)
          badge = '<span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">‚≠ê Excellente dag!</span>';
        }

        if (percentAboveSodium > 75) {
          badge += ' <span class="inline-block px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-700">üßÇ Vaak veel zout</span>';
        }
        
        // Color logic helpers with gradient thresholds
        const getProteinColor = (val) => {
          const v = parseFloat(val);
          if (v < 36) return 'text-red-600';
          if (v < 72) return 'text-yellow-600';
          return 'text-green-600';
        };
        
        const getFiberColor = (val) => {
          const v = parseFloat(val);
          if (v < 17.5) return 'text-red-600';
          if (v < 35) return 'text-yellow-600';
          return 'text-green-600';
        };

        html += `
          <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg shadow-md p-4 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-lg font-bold text-gray-800">${weekday.name}</h4>
              <span class="text-2xl">${weekday.emoji}</span>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Calorie√´n:</span>
                <span class="font-semibold ${avg.calories < 1900 ? 'text-green-600' : 'text-red-600'}">${avg.calories} kcal</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Eiwit:</span>
                <span class="font-semibold ${getProteinColor(avg.protein)}">${avg.protein}g</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Verz. vet:</span>
                <span class="font-semibold ${avg.saturatedFat < 20 ? 'text-green-600' : 'text-red-600'}">${avg.saturatedFat}g</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Vezels:</span>
                <span class="font-semibold ${getFiberColor(avg.fiber)}">${avg.fiber}g</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Natrium:</span>
                <span class="font-semibold ${avg.sodium < 2300 ? 'text-green-600' : 'text-red-600'}">${avg.sodium}mg</span>
              </div>
            </div>
            ${badge ? `<div class="mt-3 space-y-1">${badge}</div>` : ''}
            <div class="mt-3 text-xs text-gray-500">Gebaseerd op ${weekday.days.length} dag${weekday.days.length !== 1 ? 'en' : ''}</div>
          </div>
        `;
      });

      document.getElementById('weekday-trends').innerHTML = html;
    }

    window.updateAnalysis = updateAnalysis;
  </script>


<script>
// ============================================
// Backup Reminder Functionality
// ============================================

// Check if backup reminder should be shown
async function checkBackupReminder() {
  // Guard: Check if database is initialized
  if (!window.db) {
    console.log('Database not yet initialized, skipping backup reminder check');
    return;
  }
  
  try {
    // Check if reminder is enabled (default: true if not set)
    const enabledSetting = await window.db.settings.get('backup_reminder_enabled');
    const isEnabled = enabledSetting ? enabledSetting.value : true;
    
    if (!isEnabled) {
      return; // Reminder disabled by user
    }
    
    const daysSetting = await window.db.settings.get('backup_reminder_days');
    const reminderDays = daysSetting ? daysSetting.value : 14;
    
    const lastBackup = await window.db.settings.get('last_backup_date');
    if (!lastBackup) {
      // Never backed up, show reminder after some time
      // Don't show immediately on first visit, wait at least 1 day
      const firstVisit = await window.db.settings.get('first_visit_date');
      if (!firstVisit) {
        // First time ever, save current date
        await window.db.settings.put({
          key: 'first_visit_date',
          value: new Date().toISOString()
        });
        return; // Don't show on first visit
      }
      
      const firstVisitDate = new Date(firstVisit.value);
      const now = new Date();
      const daysSinceFirstVisit = Math.floor((now - firstVisitDate) / (1000 * 60 * 60 * 24));
      
      if (daysSinceFirstVisit >= 1) {
        // Show reminder after 1+ days of no backup
        showBackupReminder(999); // Large number to show "never backed up"
      }
      return;
    }
    
    const lastBackupDate = new Date(lastBackup.value);
    const now = new Date();
    const daysSinceBackup = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
    
    if (daysSinceBackup >= reminderDays) {
      showBackupReminder(daysSinceBackup);
    }
  } catch (error) {
    console.error('Error checking backup reminder:', error);
  }
}

// Show backup reminder banner
function showBackupReminder(daysSinceBackup) {
  const banner = document.getElementById('backup-reminder');
  const text = document.getElementById('backup-reminder-text');
  
  if (!banner || !text) return;
  
  if (daysSinceBackup >= 999) {
    text.textContent = 'Je hebt nog nooit een backup gemaakt.';
  } else {
    text.textContent = `Het is al ${daysSinceBackup} dagen geleden sinds je laatste backup.`;
  }
  
  banner.classList.remove('hidden');
}

// Dismiss backup reminder
function dismissBackupReminder() {
  const banner = document.getElementById('backup-reminder');
  if (banner) {
    banner.classList.add('hidden');
  }
}

// Toggle backup reminder
async function toggleBackupReminder() {
  // Guard: Check if database is initialized
  if (!window.db) {
    console.error('Cannot toggle backup reminder: database not initialized');
    return;
  }
  
  const toggle = document.getElementById('backup-reminder-toggle');
  const settings = document.getElementById('backup-reminder-settings');
  
  if (!toggle || !settings) return;
  
  const enabled = toggle.checked;
  
  try {
    await window.db.settings.put({
      key: 'backup_reminder_enabled',
      value: enabled
    });
    
    if (enabled) {
      settings.classList.remove('hidden');
    } else {
      settings.classList.add('hidden');
      dismissBackupReminder();
    }
  } catch (error) {
    console.error('Error toggling backup reminder:', error);
  }
}

// Save backup reminder settings
async function saveBackupReminderSettings() {
  // Guard: Check if database is initialized
  if (!window.db) {
    console.error('Cannot save backup reminder settings: database not initialized');
    return;
  }
  
  const daysSelect = document.getElementById('backup-reminder-days');
  if (!daysSelect) return;
  
  const days = parseInt(daysSelect.value);
  
  try {
    await window.db.settings.put({
      key: 'backup_reminder_days',
      value: days
    });
    
    // Re-check if reminder should be shown
    checkBackupReminder();
  } catch (error) {
    console.error('Error saving backup reminder settings:', error);
  }
}

// Load backup reminder settings
async function loadBackupReminderSettings() {
  // Guard: Check if database is initialized
  if (!window.db) {
    console.log('Database not yet initialized, skipping backup reminder settings load');
    return;
  }
  
  try {
    const enabledSetting = await window.db.settings.get('backup_reminder_enabled');
    const daysSetting = await window.db.settings.get('backup_reminder_days');
    
    // Default values if settings don't exist
    const isEnabled = enabledSetting ? enabledSetting.value : true;
    const reminderDays = daysSetting ? daysSetting.value : 14;
    
    const toggle = document.getElementById('backup-reminder-toggle');
    const settings = document.getElementById('backup-reminder-settings');
    const daysSelect = document.getElementById('backup-reminder-days');
    
    if (toggle) {
      toggle.checked = isEnabled;
    }
    
    if (settings) {
      if (isEnabled) {
        settings.classList.remove('hidden');
      } else {
        settings.classList.add('hidden');
      }
    }
    
    if (daysSelect) {
      daysSelect.value = reminderDays;
    }
  } catch (error) {
    console.error('Error loading backup reminder settings:', error);
  }
}

// Update last backup date
async function updateLastBackupDate() {
  // Guard: Check if database is initialized
  if (!window.db) {
    console.error('Cannot update backup date: database not initialized');
    return;
  }
  
  try {
    await window.db.settings.put({
      key: 'last_backup_date',
      value: new Date().toISOString()
    });
    
    // Update display
    loadLastBackupDate();
    
    // Hide reminder if shown
    dismissBackupReminder();
  } catch (error) {
    console.error('Error updating last backup date:', error);
  }
}

// Load and display last backup date
async function loadLastBackupDate() {
  // Guard: Check if database is initialized
  if (!window.db) {
    console.log('Database not yet initialized, skipping last backup date load');
    return;
  }
  
  try {
    const lastBackup = await window.db.settings.get('last_backup_date');
    const displayElement = document.getElementById('last-backup-date');
    
    if (!displayElement) return;
    
    if (!lastBackup) {
      displayElement.textContent = 'Nooit';
    } else {
      const date = new Date(lastBackup.value);
      const now = new Date();
      const daysDiff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (daysDiff === 0) {
        displayElement.textContent = 'Vandaag';
      } else if (daysDiff === 1) {
        displayElement.textContent = 'Gisteren';
      } else {
        displayElement.textContent = `${daysDiff} dagen geleden (${date.toLocaleDateString('nl-NL')})`;
      }
    }
  } catch (error) {
    console.error('Error loading last backup date:', error);
  }
}

// Go to Data tab (called from reminder banner)
function goToDataTab() {
  switchTab('data');
  dismissBackupReminder();
}

// Load Data Tab - called when switching to data tab
function loadDataTab() {
  // Load last backup date display
  loadLastBackupDate();
  
  // Load backup reminder settings (toggle and interval)
  loadBackupReminderSettings();
  
  // Initialize default settings if they don't exist
  initializeBackupDefaults();
}

// Initialize default backup settings
async function initializeBackupDefaults() {
  if (!window.db) return;
  
  try {
    // Check if backup reminder enabled setting exists
    const enabledSetting = await window.db.settings.get('backup_reminder_enabled');
    if (!enabledSetting) {
      // Set default: enabled
      await window.db.settings.put({
        key: 'backup_reminder_enabled',
        value: true
      });
    }
    
    // Check if reminder days setting exists
    const daysSetting = await window.db.settings.get('backup_reminder_days');
    if (!daysSetting) {
      // Set default: 14 days
      await window.db.settings.put({
        key: 'backup_reminder_days',
        value: 14
      });
    }
  } catch (error) {
    console.error('Error initializing backup defaults:', error);
  }
}

</script>

<script>
// ============================================
// Local Backup Functionality
// ============================================

// Helper function to show status messages
function showStatus(elementId, message, type) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  element.textContent = message;
  element.className = 'mt-3 text-sm';
  
  if (type === 'success') {
    element.className += ' text-green-600';
  } else if (type === 'error') {
    element.className += ' text-red-600';
  } else {
    element.className += ' text-blue-600';
  }
}

// Download backup from Data Tab
async function downloadMainDataFromDataTab() {
  // Guard: Check if database is initialized
  if (!window.db) {
    showStatus('local-backup-status', '‚ùå Database niet ge√Ønitialiseerd', 'error');
    return;
  }
  
  try {
    showStatus('local-backup-status', 'üîÑ Voorbereiden van backup...', 'info');
    
    const entries = await window.db.entries.toArray();
    const products = await window.db.products.toArray();
    const weights = await window.db.weights.toArray();
    const settings = await window.db.settings.toArray();
    
    const data = {
      entries,
      products,
      weights,
      settings,
      exportDate: new Date().toISOString(),
      version: '1.0'
    };
    
    // Use base64 data URI method (works better on mobile!)
    const content = JSON.stringify(data, null, 2);
    const utf8Bytes = new TextEncoder().encode(content);
    let binaryString = '';
    utf8Bytes.forEach(byte => {
      binaryString += String.fromCharCode(byte);
    });
    const base64 = btoa(binaryString);
    
    const dataUri = 'data:text/plain;charset=utf-8;base64,' + base64;
    const a = document.createElement('a');
    a.href = dataUri;
    a.download = `voedseljournaal-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Update last backup date
    updateLastBackupDate();
    
    showStatus('local-backup-status', '‚úì Backup gedownload!', 'success');
  } catch (error) {
    console.error('Error downloading backup:', error);
    showStatus('local-backup-status', `‚ùå Fout bij downloaden: ${error.message}`, 'error');
  }
}

// Show import modal
function showImportModal() {
  const modal = document.getElementById('import-modal');
  if (modal) {
    modal.classList.remove('hidden');
    // Clear previous file selection
    const fileInput = document.getElementById('import-file-input');
    if (fileInput) fileInput.value = '';
    document.getElementById('import-status').textContent = '';
  }
}

// Close import modal
function closeImportModal() {
  const modal = document.getElementById('import-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// Execute import
async function executeImport() {
  const fileInput = document.getElementById('import-file-input');
  const overwrite = document.getElementById('import-overwrite-checkbox').checked;
  const statusElement = document.getElementById('import-status');
  
  // Guard: Check if database is initialized
  if (!window.db) {
    statusElement.textContent = '‚ùå Database niet ge√Ønitialiseerd';
    statusElement.className = 'mb-4 text-sm text-red-600';
    return;
  }
  
  if (!fileInput.files || fileInput.files.length === 0) {
    statusElement.textContent = '‚ö†Ô∏è Selecteer eerst een bestand';
    statusElement.className = 'mb-4 text-sm text-red-600';
    return;
  }
  
  const file = fileInput.files[0];
  
  try {
    statusElement.textContent = 'üîÑ Importeren...';
    statusElement.className = 'mb-4 text-sm text-blue-600';
    
    const text = await file.text();
    const data = JSON.parse(text);
    
    // Validate data structure
    if (!data.entries || !data.products || !data.weights) {
      throw new Error('Ongeldig backup bestand');
    }
    
    let imported = {
      entries: 0,
      products: 0,
      weights: 0,
      settings: 0
    };
    
    // Import entries
    for (const entry of data.entries) {
      if (overwrite) {
        await window.db.entries.put(entry);
        imported.entries++;
      } else {
        const existing = await window.db.entries.get(entry.id);
        if (!existing || new Date(entry.updated_at) > new Date(existing.updated_at)) {
          await window.db.entries.put(entry);
          imported.entries++;
        }
      }
    }
    
    // Import products
    for (const product of data.products) {
      if (overwrite) {
        await window.db.products.put(product);
        imported.products++;
      } else {
        const existing = await window.db.products.get(product.id);
        if (!existing || new Date(product.updated_at) > new Date(existing.updated_at)) {
          await window.db.products.put(product);
          imported.products++;
        }
      }
    }
    
    // Import weights
    for (const weight of data.weights) {
      if (overwrite) {
        await window.db.weights.put(weight);
        imported.weights++;
      } else {
        const existing = await window.db.weights.get(weight.id);
        if (!existing || new Date(weight.created_at) > new Date(existing.created_at)) {
          await window.db.weights.put(weight);
          imported.weights++;
        }
      }
    }
    
    // Import settings
    if (data.settings) {
      for (const setting of data.settings) {
        // Don't overwrite certain settings
        if (!['backup_reminder_enabled', 'backup_reminder_days', 'last_backup_date'].includes(setting.key)) {
          await window.db.settings.put(setting);
          imported.settings++;
        }
      }
    }
    
    statusElement.textContent = `‚úì Import succesvol! ${imported.entries} entries, ${imported.products} producten, ${imported.weights} gewichten, ${imported.settings} instellingen`;
    statusElement.className = 'mb-4 text-sm text-green-600';
    
    // Refresh current view after a delay
    setTimeout(() => {
      closeImportModal();
      if (typeof loadDashboard === 'function') loadDashboard();
      if (typeof loadAnalysis === 'function') loadAnalysis();
    }, 2000);
    
  } catch (error) {
    console.error('Import error:', error);
    statusElement.textContent = `‚ùå Import mislukt: ${error.message}`;
    statusElement.className = 'mb-4 text-sm text-red-600';
  }
}

</script>

<!-- Import Modal -->
<div id="import-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
    <h3 class="text-2xl font-bold mb-4">Import Backup</h3>
    <p class="text-gray-600 mb-4">
      Selecteer een backup bestand om te importeren. De data wordt samengevoegd met je huidige data.
    </p>
    
    <div class="mb-4">
      <input 
        type="file" 
        id="import-file-input" 
        accept=".json"
        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
      />
    </div>

    <div class="mb-4">
      <label class="flex items-center gap-2">
        <input 
          type="checkbox" 
          id="import-overwrite-checkbox"
          class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
        />
        <span class="text-sm text-gray-700">
          Overschrijf bestaande data bij conflicten
        </span>
      </label>
      <p class="text-xs text-gray-500 mt-1 ml-6">
        Standaard worden conflicten opgelost op basis van timestamps (nieuwste wint)
      </p>
    </div>

    <div id="import-status" class="mb-4 text-sm"></div>

    <div class="flex gap-3">
      <button 
        onclick="executeImport()" 
        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
      >
        Import
      </button>
      <button 
        onclick="closeImportModal()" 
        class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
      >
        Annuleren
      </button>
    </div>
  </div>
</div>

</body>
</html>
